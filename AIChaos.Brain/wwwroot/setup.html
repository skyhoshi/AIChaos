<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chaos - Setup</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ AI CHAOS CONTROL</h1>
            <p>Control GMod through AI-powered chat commands</p>
        </div>
        
        <div class="nav">
            <a href="/" class="nav-link">‚ö° Control Panel</a>
            <a href="/setup" class="nav-link active">üîß Setup</a>
            <a href="/history" class="nav-link">üìú History</a>
        </div>
        
        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <div class="card">
                <h2>üîí Admin Access Required</h2>
                <div id="loginAlert"></div>
                
                <div id="setPasswordForm" class="hidden">
                    <p style="color: var(--text-dim);">Set your admin password to continue:</p>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" placeholder="Enter password (min 4 chars)">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm password">
                    </div>
                    <button onclick="setPassword()">Set Password</button>
                </div>
                
                <div id="loginForm">
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter admin password" onkeydown="if(event.key==='Enter')login()">
                    </div>
                    <button onclick="login()">üîì Login</button>
                </div>
            </div>
        </div>
        
        <!-- Setup Content (hidden until logged in) -->
        <div id="setupContent" class="hidden">
            <div id="alerts"></div>
            
            <!-- Admin Password -->
            <div class="card">
                <h2>üîë Admin Password</h2>
                <p style="color: var(--text-dim);">Change the admin password for Setup and History pages.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" id="currentPassword" placeholder="Current password">
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="changePassword" placeholder="New password">
                    </div>
                </div>
                <button onclick="changePassword()" class="btn-secondary">üîÑ Change Password</button>
            </div>
            
            <!-- OpenRouter API -->
            <div class="card">
                <h2>
                    ü§ñ OpenRouter API
                    <span id="openrouterStatus" class="status-badge status-disconnected">Not Configured</span>
                </h2>
                <p style="color: var(--text-dim); margin-bottom: 15px;">
                    OpenRouter provides access to AI models for generating Lua code.
                </p>
                
                <div class="setup-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Get an API Key</h4>
                        <p>Visit <a href="https://openrouter.ai/keys" target="_blank" style="color: var(--info);">openrouter.ai/keys</a> to create an account and generate an API key.</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="openrouterApiKey" placeholder="sk-or-v1-...">
                </div>
                
                <div class="form-group">
                    <label>AI Model</label>
                    <select id="openrouterModel">
                        <option value="">Loading models...</option>
                    </select>
                    <small>Choose the AI model for generating Lua code</small>
                </div>
                
                <button onclick="saveOpenRouter()">üíæ Save OpenRouter Settings</button>
            </div>
            
            <!-- Tunnel Configuration -->
            <div class="card">
                <h2>
                    üåê Tunnel Configuration
                    <span id="tunnelStatus" class="status-badge status-disconnected">Not Running</span>
                </h2>
                
                <div class="alert alert-warning" style="margin-bottom: 15px;">
                    <strong>‚ö†Ô∏è Required for GMod:</strong> GMod does not allow local HTTP connections. You must start a tunnel for GMod to communicate with the brain. The Lua file will be automatically updated with the tunnel URL.
                </div>
                
                <p style="color: var(--text-dim); margin-bottom: 15px;">
                    Set up a tunnel to expose your local server to GMod. Choose between ngrok or LocalTunnel.
                </p>
                
                <div id="tunnelUrl" class="tunnel-url hidden">
                    <strong>Public URL:</strong> <a id="tunnelUrlLink" href="#" target="_blank"></a>
                    <div style="margin-top: 5px; color: var(--text-dim); font-size: 12px;">
                        Poll URL (for GMod): <code id="pollUrl"></code>
                    </div>
                    <div style="margin-top: 5px; color: var(--success); font-size: 12px;">
                        ‚úÖ Lua file updated automatically - copy lua/ folder to your GMod addons
                    </div>
                </div>
                
                <div id="publicIpInfo" class="alert alert-info hidden">
                    <strong>LocalTunnel Password:</strong> When first visiting, enter your public IP: <code id="publicIp"></code>
                </div>
                
                <!-- Installation instructions -->
                <div class="setup-step" style="margin-bottom: 20px;">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Install a Tunnel Tool (choose one)</h4>
                        <div style="margin-top: 10px;">
                            <strong style="color: var(--accent);">Option A: ngrok</strong> (Recommended - more stable)
                            <ol style="margin: 5px 0 15px 20px; color: var(--text-dim);">
                                <li>Go to <a href="https://ngrok.com/download" target="_blank" style="color: var(--info);">ngrok.com/download</a></li>
                                <li>Download and install ngrok for your OS</li>
                                <li>(Optional) Sign up for free to get an auth token for longer sessions</li>
                            </ol>
                            
                            <strong style="color: var(--accent);">Option B: LocalTunnel</strong> (No signup required)
                            <ol style="margin: 5px 0 0 20px; color: var(--text-dim);">
                                <li>Install Node.js from <a href="https://nodejs.org" target="_blank" style="color: var(--info);">nodejs.org</a> if not installed</li>
                                <li>Run: <code style="background: #333; padding: 2px 6px; border-radius: 3px;">npm install -g localtunnel</code></li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <div class="setup-step" style="margin-bottom: 20px;">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h4>Start the Tunnel</h4>
                        <p style="color: var(--text-dim);">Click one of the buttons below to start your tunnel. The Lua file will be automatically updated with the public URL.</p>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>ngrok Auth Token (optional)</label>
                        <input type="password" id="ngrokToken" placeholder="Get from ngrok.com/download">
                        <small>Free tier works without token, but with limits</small>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button onclick="startNgrok()" id="ngrokStartBtn">üöÄ Start ngrok</button>
                    <button onclick="startLocalTunnel()" id="ltStartBtn">üöÄ Start LocalTunnel</button>
                    <button onclick="stopTunnel()" id="tunnelStopBtn" class="btn-danger hidden">‚èπÔ∏è Stop Tunnel</button>
                </div>
                
                <div id="tunnelError" class="alert alert-danger hidden" style="margin-top: 15px;"></div>
            </div>
            
            <!-- Twitch Integration -->
            <div class="card">
                <h2>
                    <span style="color: #9146ff;">üì∫</span> Twitch Integration
                    <span id="twitchStatus" class="status-badge status-disconnected">Not Connected</span>
                </h2>
                <p style="color: var(--text-dim); margin-bottom: 15px;">
                    Connect to Twitch to receive chaos commands from your chat.
                </p>
                
                <div class="setup-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Create a Twitch Application</h4>
                        <p>Go to <a href="https://dev.twitch.tv/console/apps" target="_blank" style="color: var(--info);">dev.twitch.tv/console</a> and create a new application. Set the OAuth Redirect URL to: <code id="twitchRedirectUrl">Loading...</code></p>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Client ID</label>
                        <input type="text" id="twitchClientId" placeholder="Your Twitch Client ID">
                    </div>
                    <div class="form-group">
                        <label>Client Secret</label>
                        <input type="password" id="twitchClientSecret" placeholder="Your Twitch Client Secret">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Channel Name</label>
                        <input type="text" id="twitchChannel" placeholder="Your channel name">
                    </div>
                    <div class="form-group">
                        <label>Chat Command</label>
                        <input type="text" id="twitchCommand" value="!chaos" placeholder="!chaos">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="twitchRequireBits">
                        <label for="twitchRequireBits" style="margin: 0;">Require Bits</label>
                    </div>
                    <div class="form-group">
                        <label>Minimum Bits</label>
                        <input type="number" id="twitchMinBits" value="100" min="1">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button onclick="saveTwitchCredentials()" class="btn-secondary">üíæ Save Credentials</button>
                    <button onclick="authorizeTwitch()" class="twitch-btn">üîó Login with Twitch</button>
                    <button onclick="connectTwitch()" id="twitchConnectBtn" class="btn-info">‚ñ∂Ô∏è Start Listening</button>
                    <button onclick="disconnectTwitch()" id="twitchDisconnectBtn" class="btn-danger hidden">‚èπÔ∏è Stop</button>
                </div>
            </div>
            
            <!-- YouTube Integration -->
            <div class="card">
                <h2>
                    <span style="color: #ff0000;">üì∫</span> YouTube Integration
                    <span id="youtubeStatus" class="status-badge status-disconnected">Not Connected</span>
                </h2>
                <p style="color: var(--text-dim); margin-bottom: 15px;">
                    Connect to YouTube to receive Super Chat commands from your live stream.
                </p>
                
                <div class="setup-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h4>Create a Google Cloud Project</h4>
                        <p>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: var(--info);">Google Cloud Console</a>, create a project, enable the YouTube Data API v3, and create OAuth credentials. Set the redirect URI to: <code id="youtubeRedirectUrl">Loading...</code></p>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Client ID</label>
                        <input type="text" id="youtubeClientId" placeholder="Your Google Client ID">
                    </div>
                    <div class="form-group">
                        <label>Client Secret</label>
                        <input type="password" id="youtubeClientSecret" placeholder="Your Google Client Secret">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Live Stream Video ID</label>
                        <input type="text" id="youtubeVideoId" placeholder="e.g., dQw4w9WgXcQ">
                        <small>The video ID from your live stream URL</small>
                    </div>
                    <div class="form-group">
                        <label>Minimum Super Chat ($)</label>
                        <input type="number" id="youtubeMinAmount" value="1.00" min="0" step="0.01">
                    </div>
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="youtubeAllowChat">
                    <label for="youtubeAllowChat" style="margin: 0;">Also allow regular chat commands (not just Super Chats)</label>
                </div>
                
                <div class="btn-group">
                    <button onclick="saveYouTubeCredentials()" class="btn-secondary">üíæ Save Credentials</button>
                    <button onclick="authorizeYouTube()" class="youtube-btn">üîó Login with YouTube</button>
                    <button onclick="startYouTube()" id="youtubeStartBtn" class="btn-info">‚ñ∂Ô∏è Start Listening</button>
                    <button onclick="stopYouTube()" id="youtubeStopBtn" class="btn-danger hidden">‚èπÔ∏è Stop</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isLoggedIn = false;
        let adminPassword = '';
        
        // Check admin status on load
        async function checkAdminStatus() {
            try {
                const response = await fetch('/api/setup/admin/status');
                const data = await response.json();
                
                if (!data.isConfigured) {
                    // No password set - show set password form
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('setPasswordForm').classList.remove('hidden');
                } else {
                    // Password is set - show login form
                    document.getElementById('loginForm').classList.remove('hidden');
                    document.getElementById('setPasswordForm').classList.add('hidden');
                }
            } catch (err) {
                console.error('Failed to check admin status:', err);
            }
        }
        
        async function setPassword() {
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;
            
            if (newPass.length < 4) {
                showLoginAlert('Password must be at least 4 characters', 'error');
                return;
            }
            
            if (newPass !== confirmPass) {
                showLoginAlert('Passwords do not match', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/setup/admin/password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newPassword: newPass })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    adminPassword = newPass;
                    showSetupContent();
                } else {
                    showLoginAlert(data.message || 'Failed to set password', 'error');
                }
            } catch (err) {
                showLoginAlert('Network error', 'error');
            }
        }
        
        async function login() {
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch('/api/setup/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    adminPassword = password;
                    showSetupContent();
                } else {
                    showLoginAlert(data.message || 'Invalid password', 'error');
                }
            } catch (err) {
                showLoginAlert('Network error', 'error');
            }
        }
        
        function showLoginAlert(message, type) {
            const container = document.getElementById('loginAlert');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }
        
        function showSetupContent() {
            isLoggedIn = true;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('setupContent').classList.remove('hidden');
            loadSetupStatus();
            loadModels();
        }
        
        async function changePassword() {
            const currentPass = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('changePassword').value;
            
            if (newPass.length < 4) {
                showAlert('Password must be at least 4 characters', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/setup/admin/password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword: currentPass, newPassword: newPass })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    adminPassword = newPass;
                    showAlert('Password changed successfully', 'success');
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('changePassword').value = '';
                } else {
                    showAlert(data.message || 'Failed to change password', 'error');
                }
            } catch (err) {
                showAlert('Network error', 'error');
            }
        }
        
        function showAlert(message, type) {
            const container = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.prepend(alert);
            setTimeout(() => alert.remove(), 5000);
        }
        
        async function loadSetupStatus() {
            try {
                const response = await fetch('/api/setup/status');
                const data = await response.json();
                updateSetupUI(data);
            } catch (err) {
                console.error('Failed to load setup status:', err);
            }
            
            // Update redirect URLs
            const baseUrl = window.location.origin;
            document.getElementById('twitchRedirectUrl').textContent = `${baseUrl}/api/setup/twitch/callback`;
            document.getElementById('youtubeRedirectUrl').textContent = `${baseUrl}/api/setup/youtube/callback`;
        }
        
        async function loadModels() {
            try {
                const response = await fetch('/api/setup/models');
                const data = await response.json();
                
                const select = document.getElementById('openrouterModel');
                select.innerHTML = data.models.map(m => 
                    `<option value="${m.id}" ${m.id === data.currentModel ? 'selected' : ''}>${m.name} (${m.provider})</option>`
                ).join('');
            } catch (err) {
                console.error('Failed to load models:', err);
            }
        }
        
        function updateSetupUI(data) {
            // OpenRouter
            const orStatus = document.getElementById('openrouterStatus');
            if (data.openRouterConfigured) {
                orStatus.textContent = 'Configured';
                orStatus.className = 'status-badge status-connected';
            } else {
                orStatus.textContent = 'Not Configured';
                orStatus.className = 'status-badge status-disconnected';
            }
            
            // Tunnel
            const tunnelStatus = document.getElementById('tunnelStatus');
            const tunnelUrl = document.getElementById('tunnelUrl');
            const publicIpInfo = document.getElementById('publicIpInfo');
            const ngrokStartBtn = document.getElementById('ngrokStartBtn');
            const ltStartBtn = document.getElementById('ltStartBtn');
            const tunnelStopBtn = document.getElementById('tunnelStopBtn');
            
            if (data.tunnel && data.tunnel.isRunning) {
                tunnelStatus.textContent = `${data.tunnel.type} Running`;
                tunnelStatus.className = 'status-badge status-connected';
                tunnelUrl.classList.remove('hidden');
                document.getElementById('tunnelUrlLink').href = data.tunnel.url;
                document.getElementById('tunnelUrlLink').textContent = data.tunnel.url;
                document.getElementById('pollUrl').textContent = data.tunnel.url + '/poll';
                ngrokStartBtn.classList.add('hidden');
                ltStartBtn.classList.add('hidden');
                tunnelStopBtn.classList.remove('hidden');
                
                if (data.tunnel.type === 'LocalTunnel' && data.tunnel.publicIp) {
                    publicIpInfo.classList.remove('hidden');
                    document.getElementById('publicIp').textContent = data.tunnel.publicIp;
                } else {
                    publicIpInfo.classList.add('hidden');
                }
            } else {
                tunnelStatus.textContent = 'Not Running';
                tunnelStatus.className = 'status-badge status-disconnected';
                tunnelUrl.classList.add('hidden');
                publicIpInfo.classList.add('hidden');
                ngrokStartBtn.classList.remove('hidden');
                ltStartBtn.classList.remove('hidden');
                tunnelStopBtn.classList.add('hidden');
            }
            
            // Twitch
            const twitchStatus = document.getElementById('twitchStatus');
            const twitchConnectBtn = document.getElementById('twitchConnectBtn');
            const twitchDisconnectBtn = document.getElementById('twitchDisconnectBtn');
            
            if (data.twitch.isListening) {
                twitchStatus.textContent = `Listening: ${data.twitch.channel}`;
                twitchStatus.className = 'status-badge status-connected';
                twitchConnectBtn.classList.add('hidden');
                twitchDisconnectBtn.classList.remove('hidden');
            } else if (data.twitch.isAuthenticated) {
                twitchStatus.textContent = 'Authenticated';
                twitchStatus.className = 'status-badge status-pending';
                twitchConnectBtn.classList.remove('hidden');
                twitchDisconnectBtn.classList.add('hidden');
            } else {
                twitchStatus.textContent = 'Not Connected';
                twitchStatus.className = 'status-badge status-disconnected';
                twitchConnectBtn.classList.remove('hidden');
                twitchDisconnectBtn.classList.add('hidden');
            }
            
            // YouTube
            const youtubeStatus = document.getElementById('youtubeStatus');
            const youtubeStartBtn = document.getElementById('youtubeStartBtn');
            const youtubeStopBtn = document.getElementById('youtubeStopBtn');
            
            if (data.youTube.isListening) {
                youtubeStatus.textContent = `Listening: ${data.youTube.videoId}`;
                youtubeStatus.className = 'status-badge status-connected';
                youtubeStartBtn.classList.add('hidden');
                youtubeStopBtn.classList.remove('hidden');
            } else if (data.youTube.isAuthenticated) {
                youtubeStatus.textContent = 'Authenticated';
                youtubeStatus.className = 'status-badge status-pending';
                youtubeStartBtn.classList.remove('hidden');
                youtubeStopBtn.classList.add('hidden');
            } else {
                youtubeStatus.textContent = 'Not Connected';
                youtubeStatus.className = 'status-badge status-disconnected';
                youtubeStartBtn.classList.remove('hidden');
                youtubeStopBtn.classList.add('hidden');
            }
        }
        
        // Tunnel functions
        async function startNgrok() {
            const authToken = document.getElementById('ngrokToken').value;
            const errorDiv = document.getElementById('tunnelError');
            errorDiv.classList.add('hidden');
            
            try {
                showAlert('Starting ngrok...', 'info');
                const response = await fetch('/api/setup/tunnel/ngrok/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ authToken: authToken || null })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert(`ngrok started: ${data.url}`, 'success');
                    loadSetupStatus();
                } else {
                    const errorMsg = data.message || 'Failed to start ngrok';
                    errorDiv.innerHTML = `<strong>‚ùå Error:</strong> ${errorMsg}<br><br>
                        <strong>To install ngrok:</strong><br>
                        1. Download from <a href="https://ngrok.com/download" target="_blank" style="color: var(--info);">ngrok.com/download</a><br>
                        2. Extract and add to your PATH<br>
                        3. (Optional) Run: <code>ngrok config add-authtoken YOUR_TOKEN</code>`;
                    errorDiv.classList.remove('hidden');
                    showAlert(errorMsg, 'error');
                }
            } catch (err) {
                showAlert('Network error', 'error');
            }
        }
        
        async function startLocalTunnel() {
            const errorDiv = document.getElementById('tunnelError');
            errorDiv.classList.add('hidden');
            
            try {
                showAlert('Starting LocalTunnel...', 'info');
                const response = await fetch('/api/setup/tunnel/localtunnel/start', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert(`LocalTunnel started: ${data.url}`, 'success');
                    loadSetupStatus();
                } else {
                    const errorMsg = data.message || 'Failed to start LocalTunnel';
                    errorDiv.innerHTML = `<strong>‚ùå Error:</strong> ${errorMsg}<br><br>
                        <strong>To install LocalTunnel:</strong><br>
                        1. Install Node.js from <a href="https://nodejs.org" target="_blank" style="color: var(--info);">nodejs.org</a><br>
                        2. Run: <code style="background: #333; padding: 2px 6px; border-radius: 3px;">npm install -g localtunnel</code>`;
                    errorDiv.classList.remove('hidden');
                    showAlert(errorMsg, 'error');
                }
            } catch (err) {
                showAlert('Network error', 'error');
            }
        }
        
        async function stopTunnel() {
            try {
                await fetch('/api/setup/tunnel/stop', { method: 'POST' });
                showAlert('Tunnel stopped', 'info');
                loadSetupStatus();
            } catch (err) {
                showAlert('Network error', 'error');
            }
        }
        
        // OpenRouter
        async function saveOpenRouter() {
            const apiKey = document.getElementById('openrouterApiKey').value;
            const model = document.getElementById('openrouterModel').value;
            
            try {
                const response = await fetch('/api/setup/openrouter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, model })
                });
                
                if (response.ok) {
                    showAlert('OpenRouter settings saved!', 'success');
                    loadSetupStatus();
                } else {
                    showAlert('Failed to save settings', 'error');
                }
            } catch (err) {
                showAlert('Network error', 'error');
            }
        }
        
        // Twitch
        async function saveTwitchCredentials() {
            const data = {
                clientId: document.getElementById('twitchClientId').value,
                clientSecret: document.getElementById('twitchClientSecret').value,
                channel: document.getElementById('twitchChannel').value,
                chatCommand: document.getElementById('twitchCommand').value,
                requireBits: document.getElementById('twitchRequireBits').checked,
                minBitsAmount: parseInt(document.getElementById('twitchMinBits').value) || 100
            };
            
            try {
                const response = await fetch('/api/setup/twitch/credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showAlert('Twitch credentials saved!', 'success');
                } else {
                    showAlert('Failed to save Twitch credentials', 'error');
                }
            } catch (err) {
                showAlert('Network error', 'error');
            }
        }
        
        async function authorizeTwitch() {
            try {
                const response = await fetch('/api/setup/twitch/auth-url');
                const data = await response.json();
                
                if (data.authUrl) {
                    window.location.href = data.authUrl;
                } else {
                    showAlert(data.message || 'Failed to get auth URL', 'error');
                }
            } catch (err) {
                showAlert('Network error', 'error');
            }
        }
        
        async function connectTwitch() {
            try {
                const response = await fetch('/api/setup/twitch/connect', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert(`Connected to Twitch: ${data.channel}`, 'success');
                    loadSetupStatus();
                } else {
                    showAlert(data.message || 'Failed to connect', 'error');
                }
            } catch (err) {
                showAlert('Network error', 'error');
            }
        }
        
        async function disconnectTwitch() {
            try {
                await fetch('/api/setup/twitch/disconnect', { method: 'POST' });
                showAlert('Disconnected from Twitch', 'info');
                loadSetupStatus();
            } catch (err) {
                showAlert('Network error', 'error');
            }
        }
        
        // YouTube
        async function saveYouTubeCredentials() {
            const data = {
                clientId: document.getElementById('youtubeClientId').value,
                clientSecret: document.getElementById('youtubeClientSecret').value,
                videoId: document.getElementById('youtubeVideoId').value,
                minSuperChatAmount: parseFloat(document.getElementById('youtubeMinAmount').value) || 1.00,
                allowRegularChat: document.getElementById('youtubeAllowChat').checked
            };
            
            try {
                const response = await fetch('/api/setup/youtube/credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showAlert('YouTube credentials saved!', 'success');
                } else {
                    showAlert('Failed to save YouTube credentials', 'error');
                }
            } catch (err) {
                showAlert('Network error', 'error');
            }
        }
        
        async function authorizeYouTube() {
            try {
                const response = await fetch('/api/setup/youtube/auth-url');
                const data = await response.json();
                
                if (data.authUrl) {
                    window.location.href = data.authUrl;
                } else {
                    showAlert(data.message || 'Failed to get auth URL', 'error');
                }
            } catch (err) {
                showAlert('Network error', 'error');
            }
        }
        
        async function startYouTube() {
            const videoId = document.getElementById('youtubeVideoId').value;
            
            try {
                const response = await fetch('/api/setup/youtube/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoId })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showAlert(`Started listening to YouTube: ${data.videoId}`, 'success');
                    loadSetupStatus();
                } else {
                    showAlert(data.message || 'Failed to start', 'error');
                }
            } catch (err) {
                showAlert('Network error', 'error');
            }
        }
        
        async function stopYouTube() {
            try {
                await fetch('/api/setup/youtube/stop', { method: 'POST' });
                showAlert('Stopped YouTube listener', 'info');
                loadSetupStatus();
            } catch (err) {
                showAlert('Network error', 'error');
            }
        }
        
        // Check URL for success/error messages
        const params = new URLSearchParams(window.location.search);
        if (params.get('success')) {
            // Wait for login then show message
            setTimeout(() => {
                if (isLoggedIn) {
                    showAlert(`${params.get('success')} connected successfully!`, 'success');
                }
            }, 500);
        }
        if (params.get('error')) {
            setTimeout(() => {
                if (isLoggedIn) {
                    showAlert(`Authentication failed: ${params.get('error')}`, 'error');
                }
            }, 500);
        }
        
        // Initialize
        checkAdminStatus();
    </script>
</body>
</html>
