<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chaos - Moderation & Refunds</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .image-card,
        .refund-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 4px;
            margin: 10px 0;
            display: block;
        }

        .image-url {
            word-break: break-all;
            color: var(--info);
            font-size: 12px;
        }

        .image-prompt {
            color: var(--text);
            margin: 10px 0;
        }

        .image-meta,
        .refund-meta {
            display: flex;
            gap: 15px;
            color: var(--text-dim);
            font-size: 12px;
            margin-bottom: 10px;
        }

        .pending-badge {
            background: var(--warning);
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .approved-badge {
            background: var(--success);
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .denied-badge {
            background: var(--error);
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-buttons button {
            flex: 1;
            padding: 12px;
            font-size: 14px;
        }

        .pending-count {
            background: var(--warning);
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }

        .no-images {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }

        /* Tab Styles */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            border-radius: 5px;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ AI CHAOS CONTROL</h1>
            <p>Moderation Panel</p>
        </div>

        <div class="nav">
            <a href="/" class="nav-link">‚ö° Control Panel</a>
            <a href="/setup" class="nav-link">üîß Setup</a>
            <a href="/history" class="nav-link">üìú History</a>
            <a href="/moderation" class="nav-link active">üõ°Ô∏è Moderation</a>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <div class="card">
                <h2>üîí Moderator Access Required</h2>
                <div id="loginAlert"></div>
                <div id="loginForm">
                    <p style="color: var(--text-dim); text-align: center; margin-bottom: 15px;">
                        Enter the moderation password displayed in the server console.
                    </p>
                    <div class="form-group">
                        <label>Moderation Password</label>
                        <input type="text" id="loginPassword" placeholder="Enter 6-character code" maxlength="6"
                            style="text-transform: uppercase; letter-spacing: 2px; text-align: center; font-size: 18px;"
                            onkeydown="if(event.key==='Enter')login()">
                    </div>
                    <button onclick="login()">üîì Login</button>
                </div>
            </div>
        </div>

        <!-- Moderation Content -->
        <div id="moderationContent" class="hidden">
            <div id="alerts"></div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('images')">üñºÔ∏è Images <span id="pendingImageCount"
                        class="pending-count">0</span></button>
                <button class="tab-btn" onclick="switchTab('refunds')">üí∞ Refunds <span id="pendingRefundCount"
                        class="pending-count">0</span></button>
            </div>

            <!-- IMAGES TAB -->
            <div id="imagesTab" class="tab-content active">
                <div class="card">
                    <h2>üñºÔ∏è Pending Images</h2>
                    <div class="btn-group" style="margin-bottom: 20px;">
                        <button onclick="loadPendingImages()" class="btn-secondary">üîÑ Refresh</button>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()" checked>
                            <span style="color: var(--text-dim);">Auto-refresh (5s)</span>
                        </label>
                    </div>
                    <div id="pendingImagesList">
                        <div class="no-images">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- REFUNDS TAB -->
            <div id="refundsTab" class="tab-content">
                <div class="card">
                    <h2>üí∞ Refund Requests</h2>
                    <div class="btn-group" style="margin-bottom: 20px;">
                        <button onclick="loadRefunds()" class="btn-secondary">üîÑ Refresh</button>
                    </div>
                    <div id="refundsList">
                        <div class="no-images">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isLoggedIn = false;
        let autoRefreshInterval = null;
        let moderationPassword = '';

        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-Moderation-Password': moderationPassword
            };
        }

        async function login() {
            const password = document.getElementById('loginPassword').value.toUpperCase();
            // Simple validation - real check happens on API calls
            moderationPassword = password;
            showModerationContent();
        }

        function showModerationContent() {
            isLoggedIn = true;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('moderationContent').classList.remove('hidden');
            loadPendingImages();
            loadRefunds();
            startAutoRefresh();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(tab + 'Tab').classList.add('active');
            document.querySelector(`button[onclick="switchTab('${tab}')"]`).classList.add('active');
        }

        // --- Image Logic (Existing) ---
        async function loadPendingImages() {
            try {
                const response = await fetch('/api/moderation/pending', { headers: getAuthHeaders() });
                if (response.status === 401) return showAlert('Invalid Password', 'error');
                const data = await response.json();
                document.getElementById('pendingImageCount').textContent = data.totalPending;
                renderPendingImages(data.images);
            } catch (err) { console.error(err); }
        }

        function renderPendingImages(images) {
            const container = document.getElementById('pendingImagesList');
            if (images.length === 0) {
                container.innerHTML = '<div class="no-images">‚úÖ No images pending moderation</div>';
                return;
            }
            container.innerHTML = images.map(img => `
                <div class="image-card">
                    <div class="image-meta">
                        <span><strong>#${img.id}</strong></span>
                        <span>üë§ ${escapeHtml(img.author)}</span>
                    </div>
                    <div class="image-prompt"><strong>Prompt:</strong> ${escapeHtml(img.userPrompt)}</div>
                    <img src="${escapeHtml(img.imageUrl)}" class="image-preview">
                    <div class="action-buttons">
                        <button onclick="approveImage(${img.id})" class="btn-success">‚úÖ APPROVE</button>
                        <button onclick="denyImage(${img.id})" class="btn-danger">‚ùå DENY</button>
                    </div>
                </div>
            `).join('');
        }

        async function approveImage(id) {
            await fetch('/api/moderation/approve', {
                method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ imageId: id, approved: true })
            });
            loadPendingImages();
        }

        async function denyImage(id) {
            await fetch('/api/moderation/deny', {
                method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ imageId: id, approved: false })
            });
            loadPendingImages();
        }

        // --- Refund Logic (New) ---
        async function loadRefunds() {
            try {
                const response = await fetch('/api/moderation/refund/pending', { headers: getAuthHeaders() });
                if (response.status === 401) return;
                const requests = await response.json();
                document.getElementById('pendingRefundCount').textContent = requests.length;
                renderRefunds(requests);
            } catch (err) { console.error(err); }
        }

        function renderRefunds(requests) {
            const container = document.getElementById('refundsList');
            if (requests.length === 0) {
                container.innerHTML = '<div class="no-images">‚úÖ No pending refunds</div>';
                return;
            }
            container.innerHTML = requests.map(req => `
                <div class="refund-card">
                    <div class="refund-meta">
                        <span><strong>${req.userDisplayName}</strong></span>
                        <span>Requested: ${new Date(req.requestedAt).toLocaleTimeString()}</span>
                    </div>
                    <div style="margin: 10px 0;">
                        <div><strong>Reason:</strong> <span style="color: var(--warning)">${escapeHtml(req.reason)}</span></div>
                        <div style="color: var(--text-dim); font-size: 12px; margin-top: 5px;">Prompt: "${escapeHtml(req.prompt)}"</div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="approveRefund('${req.id}')" class="btn-success">üí∞ REFUND</button>
                        <button onclick="rejectRefund('${req.id}')" class="btn-danger">‚ùå REJECT</button>
                    </div>
                </div>
            `).join('');
        }

        async function approveRefund(id) {
            await fetch('/api/moderation/refund/approve', {
                method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ requestId: id })
            });
            loadRefunds();
            showAlert('Refund approved', 'success');
        }

        async function rejectRefund(id) {
            await fetch('/api/moderation/refund/reject', {
                method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ requestId: id })
            });
            loadRefunds();
            showAlert('Refund rejected', 'warning');
        }

        // --- Utils ---
        function showAlert(msg, type) {
            const container = document.getElementById('alerts');
            container.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => container.innerHTML = '', 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function toggleAutoRefresh() {
            if (document.getElementById('autoRefresh').checked) startAutoRefresh();
            else stopAutoRefresh();
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(() => {
                loadPendingImages();
                loadRefunds();
            }, 5000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        }
    </script>
</body>

</html>