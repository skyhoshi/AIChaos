<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chaos - Viewer Control</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .credits-display {
            font-size: 18px;
            font-weight: bold;
            color: var(--success);
        }

        .refund-btn {
            background: transparent;
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 2px 8px;
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .refund-btn:hover {
            background: var(--warning);
            color: #000;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border);
        }

        .modal.active {
            display: flex;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            cursor: pointer;
        }

        .radio-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ AI CHAOS VIEWER</h1>
            <div id="authSection">
                <!-- Google Sign-In Button Container -->
                <div id="g_id_signin"></div>
            </div>
            <div id="userSection" class="hidden user-profile">
                <img id="userAvatar" src="" style="width: 30px; height: 30px; border-radius: 50%;">
                <span id="userName">Guest</span>
                <span class="credits-display">$ <span id="userCredits">0.00</span></span>
                <button onclick="signOut()"
                    style="background: none; border: none; color: var(--text-dim); cursor: pointer;">(Logout)</button>
            </div>
        </div>
        
        <div class="nav">
            <a href="/" class="nav-link active">üë• Viewer</a>
            <a href="/dashboard" class="nav-link">‚ö° Dashboard</a>
        </div>

        <!-- Main Control Card -->
        <div class="card">
            <h2>Send Chaos Command</h2>
            <div class="form-group">
                <textarea id="promptInput" placeholder="Sign in to send commands..."></textarea>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="interactiveMode" style="width: 18px; height: 18px;">
                    <span>üîÑ Interactive Mode</span>
                    <span style="color: var(--text-dim); font-size: 12px;">(AI iterates with game)</span>
                </label>
            </div>

            <button id="sendBtn" onclick="submitCommand()" disabled>üîí SIGN IN TO PLAY</button>
            <div id="status" style="margin-top: 15px;"></div>

            <!-- Interactive Status UI -->
            <div id="interactiveStatus" class="hidden"
                style="margin-top: 15px; padding: 15px; background: rgba(0,255,0,0.1); border-radius: 8px; position: relative;">
                <button id="dismissInteractive" onclick="dismissInteractiveStatus()"
                    style="position: absolute; top: 10px; right: 10px; background: transparent; border: 1px solid var(--text-dim); color: var(--text-dim); padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úï
                    Dismiss</button>
                <h4 style="margin: 0 0 10px 0;">üîÑ Interactive Session <span id="sessionStatus"></span></h4>
                <div id="interactivePhase">Phase: <span class="phase-badge">Starting...</span></div>
                <div id="interactiveIteration">Iteration: <span>0/5</span></div>
                <div id="interactiveSteps" style="margin-top: 10px;"></div>
            </div>
        </div>

        <!-- Recent History -->
        <div class="card">
            <h2>üìã Your Recent Commands</h2>
            <div id="recentCommands">
                <div class="empty-state">Sign in to see your history...</div>
            </div>
        </div>
    </div>

    <!-- Refund Modal -->
    <div id="refundModal" class="modal">
        <div class="modal-content">
            <h3>Report a Problem</h3>
            <p>Why are you requesting a refund for this command?</p>
            <div class="radio-group" id="refundReasons">
                <label class="radio-option">
                    <input type="radio" name="refundReason" value="My request didn't work">
                    My request didn't work / AI failed
                </label>
                <label class="radio-option">
                    <input type="radio" name="refundReason" value="The streamer didn't see my request">
                    The streamer didn't see my request
                </label>
                <label class="radio-option">
                    <input type="radio" name="refundReason" value="I changed my mind">
                    I changed my mind
                </label>
                <label class="radio-option">
                    <input type="radio" name="refundReason" value="It wasn't funny">
                    It wasn't funny
                </label>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeRefundModal()" class="btn-secondary">Cancel</button>
                <button onclick="submitRefund()" class="btn-primary">Submit Report</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let selectedCommandId = null;
        let currentInteractiveSessionId = null;
        let interactivePollingInterval = null;
        let currentMaxIterations = 5;

        // --- Init ---
        window.onload = async function () {
            try {
                const res = await fetch('/api/auth/config');
                const config = await res.json();

                if (config.googleClientId) {
                    google.accounts.id.initialize({
                        client_id: config.googleClientId,
                        callback: handleCredentialResponse,
                        auto_select: true
                    });

                    google.accounts.id.renderButton(
                        document.getElementById("g_id_signin"),
                        { theme: "outline", size: "large" }
                    );

                    google.accounts.id.prompt(); // Also display the One Tap dialog
                } else {
                    console.error("Google Client ID not configured");
                    document.getElementById("authSection").innerHTML = '<div class="alert alert-warning">Sign-in not configured</div>';
                }
            } catch (err) {
                console.error("Failed to load auth config", err);
            }
        };

        // --- Auth Functions ---
        function handleCredentialResponse(response) {
            const payload = parseJwt(response.credential);
            currentUser = {
                id: payload.sub,
                name: payload.name,
                email: payload.email,
                picture: payload.picture,
                token: response.credential
            };

            updateUIForUser();
            fetchBalance();
            loadHistory();
        }

        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function signOut() {
            currentUser = null;
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('sendBtn').textContent = "üîí SIGN IN TO PLAY";
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('promptInput').placeholder = "Sign in to send commands...";
            document.getElementById('recentCommands').innerHTML = '<div class="empty-state">Sign in to see your history...</div>';
        }

        function updateUIForUser() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userAvatar').src = currentUser.picture;

            document.getElementById('sendBtn').textContent = "‚ö° SEND CHAOS (0.10 Credits)";
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('promptInput').placeholder = "Ex: Make everyone tiny, Spawn 10 headcrabs...";
        }

        // --- API Functions ---
        async function fetchBalance() {
            if (!currentUser) return;
            try {
                const res = await fetch('/api/user/balance', {
                    headers: { 'X-User-Id': currentUser.id }
                });
                const data = await res.json();
                document.getElementById('userCredits').textContent = data.balance.toFixed(2);
            } catch (err) {
                console.error("Failed to fetch balance", err);
            }
        }

        async function submitCommand() {
            if (!currentUser) return;
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) return;

            const btn = document.getElementById('sendBtn');
            btn.disabled = true;
            btn.textContent = "‚è≥ Processing...";

            try {
                const isInteractive = document.getElementById('interactiveMode').checked;
                const endpoint = isInteractive ? '/trigger/interactive' : '/api/user/submit';

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Id': currentUser.id,
                        'X-User-Name': currentUser.name
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        userId: currentUser.id,
                        maxIterations: 5
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    if (isInteractive) {
                        handleInteractiveResponse(data, prompt);
                    } else {
                        document.getElementById('promptInput').value = '';
                        fetchBalance();
                        loadHistory();
                        log("Command sent successfully!", "success");
                    }
                } else {
                    log(data.message || "Failed to send command", "error");
                }
            } catch (err) {
                log("Network error", "error");
            } finally {
                if (!document.getElementById('interactiveMode').checked) {
                    btn.disabled = false;
                    btn.textContent = "‚ö° SEND CHAOS (0.10 Credits)";
                }
            }
        }

        function handleInteractiveResponse(data, originalPrompt) {
            const statusContainer = document.getElementById('interactiveStatus');
            statusContainer.classList.remove('hidden');

            if (data.maxIterations) {
                currentMaxIterations = data.maxIterations;
            }

            if (data.status === 'in_progress') {
                currentInteractiveSessionId = data.sessionId;
                log(`üîÑ Interactive session started`, 'info');
                updateInteractiveUI(data);
                startInteractivePolling(data.sessionId);
            } else if (data.status === 'complete') {
                log(`‚úì Interactive session completed`, 'success');
                updateInteractiveUI(data);
                finishInteractiveSession();
            } else if (data.status === 'failed') {
                log(`‚úó Interactive session failed: ${data.message}`, 'error');
                updateInteractiveUI(data);
                finishInteractiveSession();
            } else {
                log(`‚úó Interactive error: ${JSON.stringify(data)}`, 'error');
                finishInteractiveSession();
            }
        }

        function updateInteractiveUI(data) {
            document.querySelector('#interactivePhase .phase-badge').textContent = data.currentPhase || 'Unknown';
            document.querySelector('#interactiveIteration span').textContent = `${data.iteration || 0}/${currentMaxIterations}`;

            const sessionStatusEl = document.getElementById('sessionStatus');
            if (data.isComplete) {
                if (data.status === 'complete') {
                    sessionStatusEl.innerHTML = '<span style="color: var(--success); font-size: 12px;">‚úì Complete</span>';
                } else {
                    sessionStatusEl.innerHTML = '<span style="color: var(--error); font-size: 12px;">‚úó Failed</span>';
                }
            } else {
                sessionStatusEl.innerHTML = '<span style="color: var(--warning); font-size: 12px;">‚è≥ In Progress</span>';
            }

            const stepsContainer = document.getElementById('interactiveSteps');
            if (data.steps && data.steps.length > 0) {
                stepsContainer.innerHTML = data.steps.map(step => `
                    <div class="interactive-step" style="margin: 5px 0; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 12px;">
                        <div><strong>Step ${step.stepNumber}:</strong> ${step.phase}</div>
                        ${step.aiThinking ? `<div style="color: var(--text-dim);">üí≠ ${escapeHtml(step.aiThinking.substring(0, 100))}${step.aiThinking.length > 100 ? '...' : ''}</div>` : ''}
                        ${step.success === true ? '<span style="color: var(--success);">‚úì Success</span>' : ''}
                        ${step.success === false ? `<span style="color: var(--error);">‚úó ${escapeHtml(step.error || 'Failed')}</span>` : ''}
                    </div>
                `).join('');
            }
        }

        function startInteractivePolling(sessionId) {
            interactivePollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/interactive/${sessionId}`);
                    const data = await response.json();

                    updateInteractiveUI(data);

                    if (data.isComplete) {
                        if (data.status === 'complete') {
                            log(`‚úì Interactive session completed successfully!`, 'success');
                        } else {
                            log(`‚úó Interactive session failed`, 'error');
                        }
                        finishInteractiveSession();
                        loadHistory();
                        fetchBalance();
                    }
                } catch (err) {
                    console.error('Error polling interactive session:', err);
                }
            }, 2000);
        }

        function finishInteractiveSession() {
            if (interactivePollingInterval) {
                clearInterval(interactivePollingInterval);
                interactivePollingInterval = null;
            }
            currentInteractiveSessionId = null;

            const btn = document.getElementById('sendBtn');
            btn.disabled = false;
            btn.textContent = "‚ö° SEND CHAOS (0.10 Credits)";
            document.getElementById('promptInput').value = '';
        }

        function dismissInteractiveStatus() {
            document.getElementById('interactiveStatus').classList.add('hidden');
        }

        async function loadHistory() {
            if (!currentUser) return;
            try {
                const res = await fetch(`/api/history/user/${encodeURIComponent(currentUser.id)}`);
                const data = await res.json();
                renderHistory(data.history);
            } catch (err) {
                console.error("Failed to load history", err);
            }
        }

        function renderHistory(history) {
            const container = document.getElementById('recentCommands');
            if (!history || history.length === 0) {
                container.innerHTML = '<div class="empty-state">No commands yet.</div>';
                return;
            }

            container.innerHTML = history.slice(-10).reverse().map(cmd => `
                <div class="history-item">
                    <div style="flex: 1;">
                        <div class="history-time">${new Date(cmd.timestamp).toLocaleTimeString()}</div>
                        <div class="history-prompt">${escapeHtml(cmd.userPrompt)}</div>
                        <div class="history-status status-${getStatusClass(cmd.status)}">${getStatusText(cmd.status)}</div>
                    </div>
                    <div class="history-actions">
                        <button onclick="undoCommand(${cmd.id})" class="btn-warning btn-small">‚Ü© Undo</button>
                        <button onclick="openRefundModal(${cmd.id})" class="refund-btn">‚ö†Ô∏è Report Problem</button>
                    </div>
                </div>
            `).join('');
        }

        // --- Refund Logic ---
        function openRefundModal(commandId) {
            selectedCommandId = commandId;
            document.getElementById('refundModal').classList.add('active');
        }

        function closeRefundModal() {
            document.getElementById('refundModal').classList.remove('active');
            selectedCommandId = null;
        }

        async function submitRefund() {
            const reasonEl = document.querySelector('input[name="refundReason"]:checked');
            if (!reasonEl) {
                alert("Please select a reason");
                return;
            }

            const reason = reasonEl.value;

            try {
                const res = await fetch('/api/moderation/refund/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        userDisplayName: currentUser.name,
                        commandId: selectedCommandId,
                        reason: reason
                    })
                });

                const data = await res.json();
                alert(data.message); // "Submitted" or similar
                closeRefundModal();
            } catch (err) {
                alert("Failed to submit refund request");
            }
        }

        async function undoCommand(id) {
            // Call existing undo endpoint
            try {
                const response = await fetch('/api/undo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ commandId: id })
                });
                const data = await response.json();
                if (data.status === 'success') log('Undo queued', 'success');
                else log(data.message, 'error');
            } catch (err) {
                log('Network error', 'error');
            }
        }

        // --- Helpers ---
        function log(msg, type) {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => status.innerHTML = '', 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function getStatusClass(status) {
            if (status === 'Executed' || status === 2) return 'executed';
            if (status === 'Failed' || status === 4) return 'failed';
            return 'pending';
        }

        function getStatusText(status) {
            const statusNames = ['Pending', 'Queued', 'Executed', 'Undone', 'Failed'];
            return typeof status === 'number' ? statusNames[status] || 'Unknown' : status;
        }

        // Auto-refresh history
        setInterval(loadHistory, 5000);
    </script>
</body>

</html>