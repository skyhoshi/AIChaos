<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chaos Control</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ AI CHAOS CONTROL</h1>
            <p>Control GMod through AI-powered chat commands</p>
        </div>
        
        <div class="nav">
            <a href="/" class="nav-link active">‚ö° Control Panel</a>
            <a href="/setup" class="nav-link">üîß Setup</a>
            <a href="/history" class="nav-link">üìú History</a>
        </div>
        
        <div class="card">
            <h2>Send Chaos Command</h2>
            <div class="form-group">
                <textarea id="promptInput" placeholder="Ex: Make everyone tiny, Spawn 10 headcrabs, Turn the screen upside down..."></textarea>
            </div>
            <button id="sendBtn" onclick="sendPrompt()">‚ö° SEND CHAOS</button>
            
            <div id="status" style="margin-top: 15px;"></div>
        </div>
        
        <div class="card">
            <h2>üìã Recent Commands</h2>
            <div id="recentCommands">
                <div class="empty-state">Commands will appear here...</div>
            </div>
        </div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const promptInput = document.getElementById('promptInput');
        const sendBtn = document.getElementById('sendBtn');
        
        // Generate or retrieve a unique user ID for this browser
        function getUserId() {
            let userId = localStorage.getItem('aichaos_user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substring(2, 15) + Date.now().toString(36);
                localStorage.setItem('aichaos_user_id', userId);
            }
            return userId;
        }
        
        const userId = getUserId();
        
        function log(msg, type = 'normal') {
            const el = document.createElement('div');
            el.className = 'log-entry ' + type;
            el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            statusDiv.prepend(el);
        }
        
        async function sendPrompt() {
            const text = promptInput.value.trim();
            if (!text) return;
            
            promptInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.textContent = "‚è≥ GENERATING...";
            
            try {
                const response = await fetch('/trigger', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: text, userId: userId })
                });
                
                const data = await response.json();
                
                if (data.status === 'queued') {
                    log(`‚úì ${text}`, 'success');
                    if (data.aiResponse) {
                        log(`üí¨ AI: ${data.aiResponse}`, 'info');
                    }
                    loadRecentCommands();
                } else if (data.status === 'ignored') {
                    log(`‚úó BLOCKED: ${data.message}`, 'error');
                } else {
                    log(`‚úó ERROR: ${JSON.stringify(data)}`, 'error');
                }
            } catch (err) {
                log(`‚úó NETWORK ERROR: ${err.message}`, 'error');
            }
            
            promptInput.value = '';
            promptInput.disabled = false;
            sendBtn.disabled = false;
            sendBtn.textContent = "‚ö° SEND CHAOS";
            promptInput.focus();
        }
        
        promptInput.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                sendPrompt();
            }
        });
        
        async function loadRecentCommands() {
            try {
                // Load only this user's commands
                const response = await fetch(`/api/history/user/${encodeURIComponent(userId)}`);
                const data = await response.json();
                
                const container = document.getElementById('recentCommands');
                const recent = data.history.slice(-10).reverse();
                
                if (recent.length === 0) {
                    container.innerHTML = '<div class="empty-state">Your commands will appear here...</div>';
                    return;
                }
                
                // Status enum mapping (handles both integer and string)
                const statusNames = ['Pending', 'Queued', 'Executed', 'Undone', 'Failed'];
                const getStatusName = (status) => typeof status === 'number' ? statusNames[status] || 'Unknown' : status;
                
                container.innerHTML = recent.map(cmd => {
                    const statusName = getStatusName(cmd.status);
                    return `
                    <div class="history-item">
                        <div style="flex: 1;">
                            <div class="history-time">${new Date(cmd.timestamp).toLocaleTimeString()}</div>
                            <div class="history-prompt">${escapeHtml(cmd.userPrompt)}</div>
                            ${cmd.aiResponse ? `<div class="history-response">üí¨ ${escapeHtml(cmd.aiResponse)}</div>` : ''}
                            ${statusName === 'Failed' && cmd.errorMessage ? `<div class="history-error">‚ö†Ô∏è ${escapeHtml(cmd.errorMessage)}</div>` : ''}
                        </div>
                        <span class="history-source ${cmd.source}">${cmd.source}</span>
                        <span class="history-status status-${statusName.toLowerCase()}">${statusName}</span>
                        <div class="history-actions">
                            <button onclick="repeatCommand(${cmd.id})" class="btn-info btn-small">üîÅ</button>
                            <button onclick="undoCommand(${cmd.id})" class="btn-warning btn-small">‚Ü©</button>
                        </div>
                    </div>
                `}).join('');
            } catch (err) {
                console.error('Failed to load recent commands:', err);
            }
        }
        
        async function repeatCommand(id) {
            try {
                const response = await fetch('/api/repeat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ commandId: id })
                });
                const data = await response.json();
                log(data.status === 'success' ? '‚úì Command repeated!' : `‚úó ${data.message}`, data.status === 'success' ? 'success' : 'error');
            } catch (err) {
                log('‚úó Network error', 'error');
            }
        }
        
        async function undoCommand(id) {
            try {
                const response = await fetch('/api/undo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ commandId: id })
                });
                const data = await response.json();
                log(data.status === 'success' ? '‚úì Command undone!' : `‚úó ${data.message}`, data.status === 'success' ? 'success' : 'error');
            } catch (err) {
                log('‚úó Network error', 'error');
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        // Initial load
        loadRecentCommands();
        
        // Auto-refresh
        setInterval(loadRecentCommands, 5000);
    </script>
</body>
</html>
