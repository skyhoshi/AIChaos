<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chaos - Viewer Control</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .credits-display {
            font-size: 18px;
            font-weight: bold;
            color: var(--success);
        }

        .refund-btn {
            background: transparent;
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 2px 8px;
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .refund-btn:hover {
            background: var(--warning);
            color: #000;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border);
        }

        .modal.active {
            display: flex;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            cursor: pointer;
        }

        .radio-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .hidden {
            display: none !important;
        }
        
        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .auth-tab {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            cursor: pointer;
            border-radius: 5px;
        }
        
        .auth-tab.active {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
        }
        
        .link-youtube-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #ff0000;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ AI CHAOS VIEWER</h1>
            <div id="authSection">
                <button onclick="showLoginModal()" style="padding: 8px 16px;">üîì Login / Register</button>
            </div>
            <div id="userSection" class="hidden user-profile">
                <img id="userAvatar" src="" alt="" style="width: 28px; height: 28px; border-radius: 50%; display: none;">
                <span id="userName" onclick="showProfileModal()" style="cursor: pointer;" title="View profile">Guest</span>
                <span class="credits-display">$ <span id="userCredits">0.00</span></span>
                <button id="linkYouTubeBtn" onclick="showLinkYouTubeModal()" title="Link YouTube Channel"
                    style="background: none; border: none; color: var(--warning); cursor: pointer; font-size: 12px;">üì∫ Link YouTube</button>
                <span id="youtubeLinkedText" class="hidden" style="color: var(--success); font-size: 12px;">‚úì YouTube Linked</span>
                <button onclick="logout()"
                    style="background: none; border: none; color: var(--text-dim); cursor: pointer;">(Logout)</button>
            </div>
        </div>
        
        <!-- Login/Register Modal -->
        <div id="loginModal" class="modal">
            <div class="modal-content">
                <h3>üîê Account Access</h3>
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="showLoginTab()">Login</button>
                    <button class="auth-tab" onclick="showRegisterTab()">Register</button>
                </div>
                
                <div id="loginTab">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="loginUsername" placeholder="Your username" onkeydown="if(event.key==='Enter')doLogin()">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Your password" onkeydown="if(event.key==='Enter')doLogin()">
                    </div>
                    <div id="loginError" style="color: var(--error); margin: 10px 0;"></div>
                    <button onclick="doLogin()">üîì Login</button>
                </div>
                
                <div id="registerTab" class="hidden">
                    <div class="form-group">
                        <label>Username (min 3 chars)</label>
                        <input type="text" id="registerUsername" placeholder="Choose a username">
                    </div>
                    <div class="form-group">
                        <label>Display Name (optional)</label>
                        <input type="text" id="registerDisplayName" placeholder="How you want to be shown">
                    </div>
                    <div class="form-group">
                        <label>Password (min 4 chars)</label>
                        <input type="password" id="registerPassword" placeholder="Choose a password">
                    </div>
                    <div id="registerError" style="color: var(--error); margin: 10px 0;"></div>
                    <button onclick="doRegister()">‚ú® Create Account</button>
                </div>
                
                <button onclick="closeLoginModal()" style="margin-top: 15px; background: transparent; border: 1px solid var(--border); color:white;">Cancel</button>
            </div>
        </div>
        
        <!-- Link YouTube Modal -->
        <div id="linkYouTubeModal" class="modal">
            <div class="modal-content">
                <h3>üì∫ Link Your YouTube Channel</h3>
                <p style="color: var(--text-dim);">To receive credits from Super Chats, you need to link your YouTube channel.</p>
                
                <!-- Method Selection -->
                <div id="linkMethodSelect" style="margin: 15px 0;">
                    <p><strong>Choose a method:</strong></p>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button onclick="showOAuthLinkMethod()" class="auth-tab" id="oauthMethodBtn">üîê Google Sign-In</button>
                        <button onclick="showCodeLinkMethod()" class="auth-tab" id="codeMethodBtn">üé´ Verification Code</button>
                    </div>
                </div>
                
                <!-- OAuth Method -->
                <div id="linkOAuthMethod" class="hidden" style="margin-top: 15px;">
                    <p style="color: var(--text-dim); margin-bottom: 10px;">Sign in with Google to instantly link your YouTube channel:</p>
                    <div id="g_id_link_signin"></div>
                    <p id="oauthNotConfigured" class="hidden" style="color: var(--warning); margin-top: 10px;">‚ö†Ô∏è Google OAuth not configured. Use the verification code method instead.</p>
                </div>
                
                <!-- Verification Code Method -->
                <div id="linkCodeMethod" class="hidden" style="margin-top: 15px;">
                    <div id="linkStep1">
                        <p><strong>Step 1:</strong> Click the button below to generate a verification code.</p>
                        <button onclick="generateLinkCode()">üé´ Generate Code</button>
                    </div>
                    
                    <div id="linkStep2" class="hidden" style="margin-top: 15px;">
                        <p><strong>Step 2:</strong> Type this code into the stream chat:</p>
                        <div style="padding: 15px; background: #000; border-radius: 8px; text-align: center; margin: 10px 0;">
                            <span id="linkCode" style="font-size: 24px; font-weight: bold; color: var(--success); letter-spacing: 3px;"></span>
                        </div>
                        <p style="color: var(--text-dim); font-size: 12px;">üí¨ If that doesn't work, try sending it as a Super Chat to bypass YouTube's spam filter.</p>
                        <p style="color: var(--text-dim); font-size: 12px; margin-top: 5px;">‚è±Ô∏è The code expires in 30 minutes.</p>
                        <p style="color: var(--info); font-size: 12px; margin-top: 8px;">üí∞ <strong>Bonus:</strong> Any Super Chats you've sent before linking will be automatically credited to your account!</p>
                    </div>
                </div>
                
                <div id="linkStatus" style="margin-top: 10px;"></div>
                
                <button onclick="closeLinkYouTubeModal()" style="margin-top: 15px; background: transparent; border: 1px solid var(--border); color:white;">Close</button>
            </div>
        </div>
        
        <div class="nav">
            <a href="/" class="nav-link active">üë• Viewer</a>
            <a href="/dashboard" class="nav-link">‚ö° Dashboard</a>
        </div>

        <!-- Main Control Card -->
        <div class="card">
            <h2>Send Chaos Command</h2>
            <div class="form-group">
                <textarea id="promptInput" placeholder="Login to send commands..."></textarea>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="interactiveMode" style="width: 18px; height: 18px;">
                    <span>üîÑ Interactive Mode</span>
                    <span style="color: var(--text-dim); font-size: 12px;">(AI iterates with game)</span>
                </label>
            </div>

            <button id="sendBtn" onclick="submitCommand()" disabled>üîí LOGIN TO PLAY</button>
            <div id="status" style="margin-top: 15px;"></div>

            <!-- Interactive Status UI -->
            <div id="interactiveStatus" class="hidden"
                style="margin-top: 15px; padding: 15px; background: rgba(0,255,0,0.1); border-radius: 8px; position: relative;">
                <button id="dismissInteractive" onclick="dismissInteractiveStatus()"
                    style="position: absolute; top: 10px; right: 10px; background: transparent; border: 1px solid var(--text-dim); color: var(--text-dim); padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úï
                    Dismiss</button>
                <h4 style="margin: 0 0 10px 0;">üîÑ Interactive Session <span id="sessionStatus"></span></h4>
                <div id="interactivePhase">Phase: <span class="phase-badge">Starting...</span></div>
                <div id="interactiveIteration">Iteration: <span>0/5</span></div>
                <div id="interactiveSteps" style="margin-top: 10px;"></div>
            </div>
        </div>

        <!-- Recent History -->
        <div class="card">
            <h2>üìã Your Recent Commands</h2>
            <div id="recentCommands">
                <div class="empty-state">Sign in to see your history...</div>
            </div>
        </div>
    </div>

    <!-- Refund Modal -->
    <div id="refundModal" class="modal">
        <div class="modal-content">
            <h3>Report a Problem</h3>
            <p>Why are you requesting a refund for this command?</p>
            <div class="radio-group" id="refundReasons">
                <label class="radio-option">
                    <input type="radio" name="refundReason" value="My request didn't work">
                    My request didn't work / AI failed
                </label>
                <label class="radio-option">
                    <input type="radio" name="refundReason" value="The streamer didn't see my request">
                    The streamer didn't see my request
                </label>
                <label class="radio-option">
                    <input type="radio" name="refundReason" value="I changed my mind">
                    I changed my mind
                </label>
                <label class="radio-option">
                    <input type="radio" name="refundReason" value="It wasn't funny">
                    It wasn't funny
                </label>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeRefundModal()" class="btn-secondary">Cancel</button>
                <button onclick="submitRefund()" class="btn-primary">Submit Report</button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <h3>üë§ Account Profile</h3>
            <div style="margin: 20px 0;">
                <div style="margin-bottom: 15px;">
                    <strong>Username:</strong>
                    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin-top: 5px; font-family: monospace;">
                        <span id="profileUsername">-</span>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Balance:</strong>
                    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin-top: 5px;">
                        $<span id="profileBalance">0.00</span>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>YouTube Linked:</strong>
                    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin-top: 5px;">
                        <span id="profileYouTubeStatus">‚ùå Not linked</span>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeProfileModal()" class="btn-primary">Close</button>
            </div>
        </div>
    </div>

    <script>
        let currentAccount = null;
        let sessionToken = null;
        let selectedCommandId = null;
        let currentInteractiveSessionId = null;
        let interactivePollingInterval = null;
        let currentMaxIterations = 5;

        // --- Init ---
        window.onload = async function () {
            // Try to restore session from localStorage
            const savedSession = localStorage.getItem('aichaos_session');
            if (savedSession) {
                sessionToken = savedSession;
                await checkSession();
            }
        };
        
        async function checkSession() {
            try {
                const res = await fetch('/api/account/session', {
                    headers: { 'X-Session-Token': sessionToken }
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    currentAccount = data.account;
                    updateUIForUser();
                    loadHistory();
                } else {
                    // Session expired
                    localStorage.removeItem('aichaos_session');
                    sessionToken = null;
                }
            } catch (err) {
                console.error("Session check failed", err);
            }
        }

        // --- Modal Functions ---
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
            showLoginTab();
        }
        
        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('loginError').textContent = '';
            document.getElementById('registerError').textContent = '';
        }
        
        function showLoginTab() {
            document.getElementById('loginTab').classList.remove('hidden');
            document.getElementById('registerTab').classList.add('hidden');
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-tab')[0].classList.add('active');
        }
        
        function showRegisterTab() {
            document.getElementById('loginTab').classList.add('hidden');
            document.getElementById('registerTab').classList.remove('hidden');
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-tab')[1].classList.add('active');
        }
        
        let googleClientIdForLink = null;
        
        function showLinkYouTubeModal() {
            document.getElementById('linkYouTubeModal').classList.add('active');
            document.getElementById('linkMethodSelect').classList.remove('hidden');
            document.getElementById('linkOAuthMethod').classList.add('hidden');
            document.getElementById('linkCodeMethod').classList.add('hidden');
            document.getElementById('linkStep1').classList.remove('hidden');
            document.getElementById('linkStep2').classList.add('hidden');
            document.getElementById('linkStatus').textContent = '';
            
            // Reset method buttons
            document.getElementById('oauthMethodBtn').classList.remove('active');
            document.getElementById('codeMethodBtn').classList.remove('active');
            
            // Check if OAuth is configured
            checkOAuthAvailability();
        }
        
        async function checkOAuthAvailability() {
            try {
                const res = await fetch('/api/auth/config');
                const config = await res.json();
                googleClientIdForLink = config.googleClientId;
            } catch (err) {
                console.error("Failed to check OAuth config", err);
            }
        }
        
        function showOAuthLinkMethod() {
            document.getElementById('linkMethodSelect').classList.add('hidden');
            document.getElementById('linkOAuthMethod').classList.remove('hidden');
            document.getElementById('linkCodeMethod').classList.add('hidden');
            document.getElementById('oauthMethodBtn').classList.add('active');
            document.getElementById('codeMethodBtn').classList.remove('active');
            
            if (googleClientIdForLink) {
                // Initialize Google Sign-In for linking
                document.getElementById('oauthNotConfigured').classList.add('hidden');
                initGoogleSignInForLink();
            } else {
                document.getElementById('oauthNotConfigured').classList.remove('hidden');
                document.getElementById('g_id_link_signin').innerHTML = '';
            }
        }
        
        function showCodeLinkMethod() {
            document.getElementById('linkMethodSelect').classList.add('hidden');
            document.getElementById('linkOAuthMethod').classList.add('hidden');
            document.getElementById('linkCodeMethod').classList.remove('hidden');
            document.getElementById('oauthMethodBtn').classList.remove('active');
            document.getElementById('codeMethodBtn').classList.add('active');
        }
        
        function initGoogleSignInForLink() {
            if (!googleClientIdForLink) return;
            
            google.accounts.id.initialize({
                client_id: googleClientIdForLink,
                callback: handleGoogleLinkResponse,
                auto_select: false
            });
            
            google.accounts.id.renderButton(
                document.getElementById("g_id_link_signin"),
                { theme: "outline", size: "large", text: "signin_with" }
            );
        }
        
        async function handleGoogleLinkResponse(response) {
            // Send the full credential to the server for verification
            try {
                const res = await fetch('/api/account/link-youtube/google', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Session-Token': sessionToken 
                    },
                    body: JSON.stringify({ credential: response.credential })
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    document.getElementById('linkStatus').innerHTML = '<div class="alert alert-success">‚úì YouTube channel linked successfully!</div>';
                    // Update the current account
                    currentAccount.linkedYouTube = data.linkedYouTube;
                    // Refresh account info
                    await checkSession();
                    setTimeout(closeLinkYouTubeModal, 2000);
                } else {
                    document.getElementById('linkStatus').innerHTML = `<div class="alert alert-error">${data.message}</div>`;
                }
            } catch (err) {
                document.getElementById('linkStatus').innerHTML = '<div class="alert alert-error">Network error</div>';
            }
        }
        
        function closeLinkYouTubeModal() {
            document.getElementById('linkYouTubeModal').classList.remove('active');
        }

        // --- Auth Functions ---
        async function doLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                document.getElementById('loginError').textContent = 'Please enter username and password';
                return;
            }
            
            try {
                const res = await fetch('/api/account/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    sessionToken = data.sessionToken;
                    currentAccount = data.account;
                    localStorage.setItem('aichaos_session', sessionToken);
                    closeLoginModal();
                    updateUIForUser();
                    loadHistory();
                } else {
                    document.getElementById('loginError').textContent = data.message;
                }
            } catch (err) {
                document.getElementById('loginError').textContent = 'Network error';
            }
        }
        
        async function doRegister() {
            const username = document.getElementById('registerUsername').value.trim();
            const displayName = document.getElementById('registerDisplayName').value.trim();
            const password = document.getElementById('registerPassword').value;
            
            if (!username || !password) {
                document.getElementById('registerError').textContent = 'Please fill in all required fields';
                return;
            }
            
            try {
                const res = await fetch('/api/account/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, displayName: displayName || null })
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    sessionToken = data.sessionToken;
                    currentAccount = data.account;
                    localStorage.setItem('aichaos_session', sessionToken);
                    closeLoginModal();
                    updateUIForUser();
                    loadHistory();
                    log('Account created! Link your YouTube to receive Super Chat credits.', 'success');
                } else {
                    document.getElementById('registerError').textContent = data.message;
                }
            } catch (err) {
                document.getElementById('registerError').textContent = 'Network error';
            }
        }

        async function logout() {
            if (sessionToken) {
                await fetch('/api/account/logout', {
                    method: 'POST',
                    headers: { 'X-Session-Token': sessionToken }
                });
            }
            
            currentAccount = null;
            sessionToken = null;
            localStorage.removeItem('aichaos_session');
            
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('sendBtn').textContent = "üîí LOGIN TO PLAY";
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('promptInput').placeholder = "Login to send commands...";
            document.getElementById('recentCommands').innerHTML = '<div class="empty-state">Login to see your history...</div>';
        }

        function updateUIForUser() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('userName').textContent = currentAccount.displayName;
            document.getElementById('userCredits').textContent = currentAccount.balance.toFixed(2);

            document.getElementById('sendBtn').textContent = "‚ö° SEND CHAOS ($0.10)";
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('promptInput').placeholder = "Ex: Make everyone tiny, Spawn 10 headcrabs...";
            
            // Update YouTube linked state
            updateYouTubeLinkState();
        }
        
        function updateYouTubeLinkState() {
            const linkBtn = document.getElementById('linkYouTubeBtn');
            const linkedText = document.getElementById('youtubeLinkedText');
            const avatar = document.getElementById('userAvatar');
            
            if (currentAccount && currentAccount.linkedYouTube) {
                // YouTube is linked - hide button, show linked text
                linkBtn.classList.add('hidden');
                linkedText.classList.remove('hidden');
                
                // Show avatar if we have picture info (from Google Sign-In)
                if (currentAccount.picture) {
                    avatar.src = currentAccount.picture;
                    avatar.style.display = 'block';
                } else {
                    // Use a stable YouTube favicon URL
                    avatar.src = 'https://www.youtube.com/favicon.ico';
                    avatar.style.display = 'block';
                }
            } else {
                // YouTube not linked - show button, hide linked text
                linkBtn.classList.remove('hidden');
                linkedText.classList.add('hidden');
                avatar.style.display = 'none';
            }
        }
        
        async function generateLinkCode() {
            try {
                const res = await fetch('/api/account/link-youtube/generate', {
                    method: 'POST',
                    headers: { 'X-Session-Token': sessionToken }
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    document.getElementById('linkCode').textContent = data.code;
                    document.getElementById('linkStep1').classList.add('hidden');
                    document.getElementById('linkStep2').classList.remove('hidden');
                } else {
                    document.getElementById('linkStatus').innerHTML = `<div class="alert alert-error">${data.message}</div>`;
                }
            } catch (err) {
                document.getElementById('linkStatus').innerHTML = '<div class="alert alert-error">Network error</div>';
            }
        }

        // --- API Functions ---
        async function fetchBalance() {
            if (!sessionToken) return;
            try {
                const res = await fetch('/api/account/balance', {
                    headers: { 'X-Session-Token': sessionToken }
                });
                const data = await res.json();
                if (data.balance !== undefined) {
                    document.getElementById('userCredits').textContent = data.balance.toFixed(2);
                }
            } catch (err) {
                console.error("Failed to fetch balance", err);
            }
        }

        async function submitCommand() {
            if (!sessionToken || !currentAccount) return;
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) return;

            const btn = document.getElementById('sendBtn');
            btn.disabled = true;
            btn.textContent = "‚è≥ Processing...";

            try {
                const isInteractive = document.getElementById('interactiveMode').checked;
                const endpoint = isInteractive ? '/trigger/interactive' : '/api/account/submit';

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Token': sessionToken
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        maxIterations: 5
                    })
                });

                const data = await res.json();

                if (res.ok && data.status === 'success') {
                    if (isInteractive) {
                        handleInteractiveResponse(data, prompt);
                    } else {
                        document.getElementById('promptInput').value = '';
                        if (data.balance !== undefined) {
                            document.getElementById('userCredits').textContent = data.balance.toFixed(2);
                        }
                        loadHistory();
                        log("Command sent successfully!", "success");
                    }
                } else {
                    log(data.message || "Failed to send command", "error");
                }
            } catch (err) {
                log("Network error", "error");
            } finally {
                if (!document.getElementById('interactiveMode').checked) {
                    btn.disabled = false;
                    btn.textContent = "‚ö° SEND CHAOS ($0.10)";
                }
            }
        }

        function handleInteractiveResponse(data, originalPrompt) {
            const statusContainer = document.getElementById('interactiveStatus');
            statusContainer.classList.remove('hidden');

            if (data.maxIterations) {
                currentMaxIterations = data.maxIterations;
            }

            if (data.status === 'in_progress') {
                currentInteractiveSessionId = data.sessionId;
                log(`üîÑ Interactive session started`, 'info');
                updateInteractiveUI(data);
                startInteractivePolling(data.sessionId);
            } else if (data.status === 'complete') {
                log(`‚úì Interactive session completed`, 'success');
                updateInteractiveUI(data);
                finishInteractiveSession();
            } else if (data.status === 'failed') {
                log(`‚úó Interactive session failed: ${data.message}`, 'error');
                updateInteractiveUI(data);
                finishInteractiveSession();
            } else {
                log(`‚úó Interactive error: ${JSON.stringify(data)}`, 'error');
                finishInteractiveSession();
            }
        }

        function updateInteractiveUI(data) {
            document.querySelector('#interactivePhase .phase-badge').textContent = data.currentPhase || 'Unknown';
            document.querySelector('#interactiveIteration span').textContent = `${data.iteration || 0}/${currentMaxIterations}`;

            const sessionStatusEl = document.getElementById('sessionStatus');
            if (data.isComplete) {
                if (data.status === 'complete') {
                    sessionStatusEl.innerHTML = '<span style="color: var(--success); font-size: 12px;">‚úì Complete</span>';
                } else {
                    sessionStatusEl.innerHTML = '<span style="color: var(--error); font-size: 12px;">‚úó Failed</span>';
                }
            } else {
                sessionStatusEl.innerHTML = '<span style="color: var(--warning); font-size: 12px;">‚è≥ In Progress</span>';
            }

            const stepsContainer = document.getElementById('interactiveSteps');
            if (data.steps && data.steps.length > 0) {
                stepsContainer.innerHTML = data.steps.map(step => `
                    <div class="interactive-step" style="margin: 5px 0; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 12px;">
                        <div><strong>Step ${step.stepNumber}:</strong> ${step.phase}</div>
                        ${step.aiThinking ? `<div style="color: var(--text-dim);">üí≠ ${escapeHtml(step.aiThinking.substring(0, 100))}${step.aiThinking.length > 100 ? '...' : ''}</div>` : ''}
                        ${step.success === true ? '<span style="color: var(--success);">‚úì Success</span>' : ''}
                        ${step.success === false ? `<span style="color: var(--error);">‚úó ${escapeHtml(step.error || 'Failed')}</span>` : ''}
                    </div>
                `).join('');
            }
        }

        function startInteractivePolling(sessionId) {
            interactivePollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/interactive/${sessionId}`);
                    const data = await response.json();

                    updateInteractiveUI(data);

                    if (data.isComplete) {
                        if (data.status === 'complete') {
                            log(`‚úì Interactive session completed successfully!`, 'success');
                        } else {
                            log(`‚úó Interactive session failed`, 'error');
                        }
                        finishInteractiveSession();
                        loadHistory();
                        fetchBalance();
                    }
                } catch (err) {
                    console.error('Error polling interactive session:', err);
                }
            }, 2000);
        }

        function finishInteractiveSession() {
            if (interactivePollingInterval) {
                clearInterval(interactivePollingInterval);
                interactivePollingInterval = null;
            }
            currentInteractiveSessionId = null;

            const btn = document.getElementById('sendBtn');
            btn.disabled = false;
            btn.textContent = "‚ö° SEND CHAOS ($0.10)";
            document.getElementById('promptInput').value = '';
        }

        function dismissInteractiveStatus() {
            document.getElementById('interactiveStatus').classList.add('hidden');
        }

        async function loadHistory() {
            if (!sessionToken || !currentAccount) return;
            try {
                const res = await fetch(`/api/history/user/${encodeURIComponent(currentAccount.id)}`);
                const data = await res.json();
                renderHistory(data.history);
            } catch (err) {
                console.error("Failed to load history", err);
            }
        }

        function renderHistory(history) {
            const container = document.getElementById('recentCommands');
            if (!history || history.length === 0) {
                container.innerHTML = '<div class="empty-state">No commands yet.</div>';
                return;
            }

            container.innerHTML = history.slice(-10).reverse().map(cmd => `
                <div class="history-item">
                    <div style="flex: 1;">
                        <div class="history-time">${new Date(cmd.timestamp).toLocaleTimeString()}</div>
                        <div class="history-prompt">${escapeHtml(cmd.userPrompt)}</div>
                        <div class="history-status status-${getStatusClass(cmd.status)}">${getStatusText(cmd.status)}</div>
                    </div>
                    <div class="history-actions">
                        <button onclick="undoCommand(${cmd.id})" class="btn-warning btn-small">‚Ü© Undo</button>
                        <button onclick="openRefundModal(${cmd.id})" class="refund-btn">‚ö†Ô∏è Report Problem</button>
                    </div>
                </div>
            `).join('');
        }

        // --- Refund Logic ---
        function openRefundModal(commandId) {
            selectedCommandId = commandId;
            document.getElementById('refundModal').classList.add('active');
        }

        function closeRefundModal() {
            document.getElementById('refundModal').classList.remove('active');
            selectedCommandId = null;
        }

        async function submitRefund() {
            const reasonEl = document.querySelector('input[name="refundReason"]:checked');
            if (!reasonEl) {
                alert("Please select a reason");
                return;
            }

            const reason = reasonEl.value;

            try {
                const res = await fetch('/api/moderation/refund/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentAccount?.id,
                        userDisplayName: currentAccount?.displayName,
                        commandId: selectedCommandId,
                        reason: reason
                    })
                });

                const data = await res.json();
                alert(data.message); // "Submitted" or similar
                closeRefundModal();
            } catch (err) {
                alert("Failed to submit refund request");
            }
        }

        function showProfileModal() {
            if (!currentAccount) return;
            
            document.getElementById('profileUsername').textContent = currentAccount.username || '-';
            document.getElementById('profileBalance').textContent = (currentAccount.creditBalance || 0).toFixed(2);
            
            const youtubeStatus = document.getElementById('profileYouTubeStatus');
            if (currentAccount.linkedYouTubeChannelId) {
                youtubeStatus.innerHTML = '‚úÖ Linked';
                youtubeStatus.style.color = 'var(--success)';
            } else {
                youtubeStatus.innerHTML = '‚ùå Not linked';
                youtubeStatus.style.color = 'var(--text-dim)';
            }
            
            document.getElementById('profileModal').classList.add('active');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        async function undoCommand(id) {
            // Call existing undo endpoint
            try {
                const response = await fetch('/api/undo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ commandId: id })
                });
                const data = await response.json();
                if (data.status === 'success') log('Undo queued', 'success');
                else log(data.message, 'error');
            } catch (err) {
                log('Network error', 'error');
            }
        }

        // --- Helpers ---
        function log(msg, type) {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
            setTimeout(() => status.innerHTML = '', 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function getStatusClass(status) {
            if (status === 'Executed' || status === 2) return 'executed';
            if (status === 'Failed' || status === 4) return 'failed';
            return 'pending';
        }

        function getStatusText(status) {
            const statusNames = ['Pending', 'Queued', 'Executed', 'Undone', 'Failed'];
            return typeof status === 'number' ? statusNames[status] || 'Unknown' : status;
        }

        // Auto-refresh balance and history
        setInterval(() => {
            if (sessionToken) {
                fetchBalance();
                loadHistory();
            }
        }, 5000);
    </script>
</body>

</html>