@inherits LayoutComponentBase
@inject AccountService AccountService
@inject IJSRuntime JS

<Header>
    <TitleContent>
        <SectionOutlet SectionId="PageSections.Title" />
    </TitleContent>
    <SubtitleContent>
        <SectionOutlet SectionId="PageSections.Subtitle" />
    </SubtitleContent>
</Header>

<AccountBar CurrentAccount="@currentAccount" OnAccountChanged="@LoadAccount" />

<NavMenu />

<div class="container">
    <CascadingValue Value="@currentAccount">
        @Body
    </CascadingValue>
</div>

@code {
    private Account? currentAccount;
    private bool _isInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isInitialized)
        {
            _isInitialized = true;
            
            // Add a small delay to ensure SignalR circuit is fully connected
            await Task.Delay(100);
            
            await LoadAccount();
        }
    }

    private async Task LoadAccount()
    {
        try
        {
            // Get session token from localStorage (secure approach)
            var sessionToken = await JS.InvokeAsync<string>("localStorage.getItem", "sessionToken");
            if (!string.IsNullOrEmpty(sessionToken))
            {
                // Validate session token with AccountService
                currentAccount = AccountService.GetAccountBySession(sessionToken);
                if (currentAccount == null)
                {
                    // Session expired or invalid, clear localStorage
                    await JS.InvokeVoidAsync("localStorage.removeItem", "sessionToken");
                }
            }
        }
        catch (Exception ex)
        {
            // Log error but don't throw - this prevents circuit crashes
            Console.WriteLine($"Error loading account: {ex.Message}");
            currentAccount = null;
        }

        await InvokeAsync(StateHasChanged);
    }
}
