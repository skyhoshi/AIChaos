@inherits LayoutComponentBase
@inject AccountService AccountService
@inject IJSRuntime JS

<div class="global-account-bar">
    <AccountBar CurrentAccount="@currentAccount" OnAccountChanged="@LoadAccount" />
</div>

<div class="container">
    <CascadingValue Value="@currentAccount">
        @Body
    </CascadingValue>
</div>

@code {
    private Account? currentAccount;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAccount();
        }
    }

    private async Task LoadAccount()
    {
        try
        {
            var sessionJson = await JS.InvokeAsync<string>("localStorage.getItem", "accountSession");
            if (!string.IsNullOrEmpty(sessionJson))
            {
                var session = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, string>>(sessionJson);
                if (session != null && session.ContainsKey("username") && session.ContainsKey("password"))
                {
                    currentAccount = await AccountService.Login(session["username"], session["password"]);
                }
            }
        }
        catch
        {
            currentAccount = null;
        }
        
        await InvokeAsync(StateHasChanged);
    }
}
