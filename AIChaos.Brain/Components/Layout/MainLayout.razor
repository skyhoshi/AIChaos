@inherits LayoutComponentBase
@inject AccountService AccountService
@inject SettingsService SettingsService
@inject IJSRuntime JS

<Header>
    <TitleContent>
        <SectionOutlet SectionId="PageSections.Title" />
    </TitleContent>
    <SubtitleContent>
        <SectionOutlet SectionId="PageSections.Subtitle" />
    </SubtitleContent>
</Header>

@* Show AccountBar if logged in user (not anonymous) OR not in single user mode *@
@if (!SettingsService.Settings.General.SingleUserMode || (currentAccount != null && currentAccount.Id != "anonymous-default-user"))
{
    <AccountBar CurrentAccount="@currentAccount" OnAccountChanged="@LoadAccount" />
}

<NavMenu />

<div class="container">
    <CascadingValue Value="@currentAccount">
        @Body
    </CascadingValue>
</div>

@code {
    private Account? currentAccount;
    private bool _isInitialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isInitialized)
        {
            _isInitialized = true;
            
            // Add a small delay to ensure SignalR circuit is fully connected
            await Task.Delay(100);
            
            await LoadAccount();
        }
    }

    private async Task LoadAccount()
    {
        try
        {
            // Always check for session token first (for admin/moderator access)
            var sessionToken = await JS.InvokeAsync<string>("localStorage.getItem", "sessionToken");
            if (!string.IsNullOrEmpty(sessionToken))
            {
                // Validate session token with AccountService
                currentAccount = AccountService.GetAccountBySession(sessionToken);
                if (currentAccount == null)
                {
                    // Session expired or invalid, clear localStorage
                    await JS.InvokeVoidAsync("localStorage.removeItem", "sessionToken");
                }
            }

            // If no session and in single user mode, use the anonymous account
            if (currentAccount == null && SettingsService.Settings.General.SingleUserMode)
            {
                currentAccount = AccountService.GetOrCreateAnonymousAccount();
            }
        }
        catch (Exception ex)
        {
            // Log error but don't throw - this prevents circuit crashes
            Console.WriteLine($"Error loading account: {ex.Message}");
            
            // Fallback to anonymous account in single user mode
            if (SettingsService.Settings.General.SingleUserMode)
            {
                currentAccount = AccountService.GetOrCreateAnonymousAccount();
            }
            else
            {
                currentAccount = null;
            }
        }

        await InvokeAsync(StateHasChanged);
    }
}
