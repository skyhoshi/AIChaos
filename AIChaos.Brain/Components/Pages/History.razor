@page "/history"
@rendermode InteractiveServer
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>AI Chaos - History</PageTitle>

<Header Title="üéÆ AI CHAOS CONTROL" Subtitle="Control GMod through AI-powered chat commands" />

<NavMenu ShowSetup="true" ShowHistory="true" />

@if (!isLoggedIn)
{
    <div class="login-container">
        <div class="card">
            <h2>üîí Admin Access Required</h2>
            @if (!string.IsNullOrEmpty(loginAlert))
            {
                <div class="alert alert-@loginAlertType">@loginAlert</div>
            }
            
            @if (!notConfigured)
            {
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" @bind="loginPassword" placeholder="Enter admin password" @onkeydown="HandleLoginKeypress">
                </div>
                <button @onclick="Login">üîì Login</button>
            }
            else
            {
                <p style="color: var(--warning); text-align: center;">
                    Admin password not configured. <a href="/setup" style="color: var(--info);">Set it up first</a>.
                </p>
            }
        </div>
    </div>
}
else
{
    <div class="card">
        <h2>üìú Command History</h2>
        
        <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 15px;">
            <div class="form-group checkbox-group" style="margin-bottom: 0;">
                <input type="checkbox" @bind="includeHistoryInAi" @bind:after="UpdatePreferences">
                <label style="margin: 0;">Feed history to AI context</label>
            </div>
            
            <div class="form-group checkbox-group" style="margin-bottom: 0;">
                <input type="checkbox" @bind="autoRefresh" @bind:after="ToggleAutoRefresh">
                <label style="margin: 0;">Auto-refresh (5s)</label>
            </div>
            
            <div class="form-group" style="margin-bottom: 0; display: flex; align-items: center; gap: 10px;">
                <label style="margin: 0; white-space: nowrap;">Max History:</label>
                <input type="number" @bind="maxHistoryLength" @bind:after="UpdatePreferences" min="10" max="500" style="width: 80px;">
            </div>
        </div>
        
        <div class="btn-group" style="margin-bottom: 20px;">
            <button @onclick="LoadHistory" class="btn-secondary">üîÑ Refresh</button>
            <button @onclick="ClearHistory" class="btn-danger">üóëÔ∏è Clear All</button>
        </div>
        
        <div>
            @if (commandHistory == null || !commandHistory.Any())
            {
                <div class="empty-state">No commands in history yet.</div>
            }
            else
            {
                @foreach (var cmd in commandHistory)
                {
                    <div class="history-item-detailed">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="history-time">
                                    #@cmd.Id - @cmd.Timestamp.ToLocalTime().ToString("g")
                                    <span class="status-badge status-@GetStatusClass(cmd.Status)">@GetStatusText(cmd.Status)</span>
                                </div>
                                <div class="history-prompt" style="margin-top: 5px;">@cmd.UserPrompt</div>
                                @if (!string.IsNullOrEmpty(cmd.ErrorMessage))
                                {
                                    <div class="error-message">
                                        ‚ö†Ô∏è <strong>Error:</strong> @cmd.ErrorMessage
                                    </div>
                                }
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="history-source">@cmd.Source</span>
                                <div class="history-actions">
                                    <button @onclick="() => RepeatCommand(cmd.Id)" class="btn-info btn-small">üîÅ Repeat</button>
                                    <button @onclick="() => UndoCommand(cmd.Id)" class="btn-warning btn-small">‚Ü© Undo</button>
                                    <button @onclick="() => ToggleCode(cmd.Id)" class="btn-secondary btn-small">üëÅ Code</button>
                                </div>
                            </div>
                        </div>
                        @if (showCodeFor == cmd.Id)
                        {
                            <div style="margin-top: 10px;">
                                <div class="code-block">
                                    <strong>Execution Code:</strong>
                                    <pre>@cmd.ExecutionCode</pre>
                                    
                                    <strong>Undo Code:</strong>
                                    <pre>@cmd.UndoCode</pre>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    </div>
}

<style>
    .login-container {
        max-width: 500px;
        margin: 50px auto;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .history-item-detailed {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .history-time {
        color: var(--text-dim);
        font-size: 12px;
    }

    .history-prompt {
        color: var(--text);
        margin: 5px 0;
    }

    .history-source {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        background: rgba(255, 255, 255, 0.1);
    }

    .status-badge {
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        margin-left: 8px;
        color: white;
    }

    .status-pending { background: #888; }
    .status-queued { background: #f0ad4e; }
    .status-executed { background: #5cb85c; }
    .status-undone { background: #5bc0de; }
    .status-failed { background: #d9534f; }

    .error-message {
        color: #ff6b6b;
        background: rgba(255, 107, 107, 0.1);
        padding: 8px;
        border-radius: 4px;
        margin-top: 8px;
        font-size: 12px;
    }

    .code-block {
        background: #000;
        padding: 15px;
        border-radius: 8px;
        color: var(--success);
        font-family: monospace;
        font-size: 12px;
    }

    .code-block pre {
        margin: 5px 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .history-actions {
        display: flex;
        gap: 5px;
    }
</style>

@code {
    private bool isLoggedIn = false;
    private string loginPassword = "";
    private string loginAlert = "";
    private string loginAlertType = "error";
    private bool notConfigured = false;
    
    private List<Command>? commandHistory;
    private bool includeHistoryInAi = false;
    private bool autoRefresh = false;
    private int maxHistoryLength = 50;
    private int? showCodeFor = null;
    
    private System.Threading.Timer? refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await CheckAdminStatus();
    }

    private async Task CheckAdminStatus()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<AdminStatusResponse>("/api/setup/admin/status");
            if (response != null && !response.IsConfigured)
            {
                notConfigured = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Admin status check failed: {ex.Message}");
        }
    }

    private async Task Login()
    {
        try
        {
            var response = await Http.PostAsJsonAsync("/api/setup/admin/login", new { password = loginPassword });
            var data = await response.Content.ReadFromJsonAsync<ApiResponse>();
            
            if (data?.Status == "success")
            {
                isLoggedIn = true;
                await LoadHistory();
            }
            else
            {
                loginAlert = data?.Message ?? "Invalid password";
                loginAlertType = "error";
            }
        }
        catch
        {
            loginAlert = "Network error";
            loginAlertType = "error";
        }
    }

    private async Task LoadHistory()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<HistoryResponse>("/api/history");
            commandHistory = response?.History?.ToList();
            includeHistoryInAi = response?.Preferences?.IncludeHistoryInAi ?? false;
            maxHistoryLength = response?.Preferences?.MaxHistoryLength ?? 50;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Load history failed: {ex.Message}");
        }
    }

    private async Task UpdatePreferences()
    {
        try
        {
            await Http.PostAsJsonAsync("/api/preferences", new 
            { 
                includeHistoryInAi,
                maxHistoryLength
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Update preferences failed: {ex.Message}");
        }
    }

    private void ToggleAutoRefresh()
    {
        if (autoRefresh)
        {
            refreshTimer = new System.Threading.Timer(async _ => 
            {
                await InvokeAsync(async () => 
                {
                    await LoadHistory();
                    StateHasChanged();
                });
            }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
        }
        else
        {
            refreshTimer?.Dispose();
            refreshTimer = null;
        }
    }

    private async Task ClearHistory()
    {
        if (await JS.InvokeAsync<bool>("confirm", "Are you sure you want to clear all command history?"))
        {
            try
            {
                await Http.PostAsync("/api/clear_history", null);
                await LoadHistory();
            }
            catch
            {
                await JS.InvokeVoidAsync("alert", "Failed to clear history");
            }
        }
    }

    private async Task RepeatCommand(int commandId)
    {
        try
        {
            var response = await Http.PostAsJsonAsync("/api/repeat", new { commandId });
            var data = await response.Content.ReadFromJsonAsync<ApiResponse>();
            await JS.InvokeVoidAsync("alert", data?.Status == "success" ? "Command repeated!" : data?.Message);
        }
        catch
        {
            await JS.InvokeVoidAsync("alert", "Network error");
        }
    }

    private async Task UndoCommand(int commandId)
    {
        try
        {
            var response = await Http.PostAsJsonAsync("/api/undo", new { commandId });
            var data = await response.Content.ReadFromJsonAsync<ApiResponse>();
            await JS.InvokeVoidAsync("alert", data?.Status == "success" ? "Undo command queued!" : data?.Message);
        }
        catch
        {
            await JS.InvokeVoidAsync("alert", "Network error");
        }
    }

    private void ToggleCode(int id)
    {
        showCodeFor = showCodeFor == id ? null : id;
    }

    private string GetStatusClass(string status) => status?.ToLower() switch
    {
        "executed" => "executed",
        "failed" => "failed",
        "queued" => "queued",
        "undone" => "undone",
        _ => "pending"
    };
    
    private string GetStatusText(string status) => status ?? "Unknown";

    private async Task HandleLoginKeypress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await Login();
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }

    // DTOs
    private class AdminStatusResponse
    {
        public bool IsConfigured { get; set; }
    }

    private class ApiResponse
    {
        public string Status { get; set; } = "";
        public string? Message { get; set; }
    }

    private class Command
    {
        public int Id { get; set; }
        public DateTime Timestamp { get; set; }
        public string UserPrompt { get; set; } = "";
        public string ExecutionCode { get; set; } = "";
        public string UndoCode { get; set; } = "";
        public string? ErrorMessage { get; set; }
        public string Source { get; set; } = "";
        public string Status { get; set; } = "Pending";  // CommandStatus enum as string
    }

    private class Preferences
    {
        public bool IncludeHistoryInAi { get; set; }
        public int MaxHistoryLength { get; set; }
    }

    private class HistoryResponse
    {
        public List<Command>? History { get; set; }
        public Preferences? Preferences { get; set; }
    }
}
