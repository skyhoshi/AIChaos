@rendermode InteractiveServer

@inject AccountService AccountService
@inject SettingsService SettingsService
@inject IJSRuntime JS
@inject NavigationManager Navigation
@implements IDisposable

@if (CurrentAccount == null)
{
    <div class="user-profile">
        <button @onclick=LoginButtonClicked style="padding: 8px 16px;">üîì Login / Register</button>
    </div>
}
else
{
    <div class="user-profile">
        @if (!string.IsNullOrEmpty(CurrentAccount.PictureUrl))
        {
            <img src="@CurrentAccount.PictureUrl" alt="" style="width: 28px; height: 28px; border-radius: 50%;">
        }
        <span @onclick="() => showProfileModal = true" style="cursor: pointer;" title="View profile">@CurrentAccount.DisplayName</span>
        @if (!string.IsNullOrEmpty(CurrentAccount.LinkedYouTubeChannelId))
        {
            <span style="color: var(--success); font-size: 12px;">‚úì YouTube Linked</span>
        }
        else
        {
            <button @onclick="OpenLinkYouTubeModal" title="Link YouTube Channel"
                    style="background: none; border: none; color: var(--warning); cursor: pointer; font-size: 12px;">üì∫ Link YouTube</button>
        }
        <button @onclick="HandleLogout"
                style="background: none; border: none; color: var(--text-dim); cursor: pointer;">(Logout)</button>
    </div>
}

<!-- Login/Register Modal -->
<Modal @bind-IsOpen="showLoginModal">
    <h3>üîê Account Access</h3>
    <div class="form-group">
        <label>Username</label>
        <input type="text" @bind="loginUsername" placeholder="Enter username" @bind:event="oninput">
    </div>
    <div class="form-group">
        <label>Password</label>
        <input type="password" @bind="loginPassword" placeholder="Enter password" @bind:event="oninput">
    </div>
    @if (!string.IsNullOrEmpty(loginError))
    {
        <div class="alert alert-error">@loginError</div>
    }
    <div style="display: flex; gap: 10px;">
        <button @onclick="Login">Login</button>
        <button @onclick="Register">Register</button>
        <button @onclick="() => showLoginModal = false" style="background: var(--bg-light); color: var(--text);">Cancel</button>
    </div>
</Modal>

<!-- Profile Modal -->
<Modal @bind-IsOpen="showProfileModal">
    <h3>üë§ Your Profile</h3>
    @if (CurrentAccount != null)
    {
        <div style="margin: 15px 0;">
            <p><strong>Username:</strong> @CurrentAccount.Username</p>
            <p><strong>Display Name:</strong> @CurrentAccount.DisplayName</p>
            <p><strong>Role:</strong> @CurrentAccount.Role</p>
            <p><strong>Credits:</strong> $@CurrentAccount.CreditBalance.ToString("F2")</p>
            @if (!string.IsNullOrEmpty(CurrentAccount.LinkedYouTubeChannelId))
            {
                <p><strong>YouTube:</strong> ‚úì Linked (@CurrentAccount.LinkedYouTubeChannelId)</p>
                <button @onclick="UnlinkYouTube" 
                        style="background: var(--warning); color: black; margin-top: 10px;"
                        disabled="@unlinkingYouTube">
                    @if (unlinkingYouTube)
                    {
                        <span>Unlinking...</span>
                    }
                    else
                    {
                        <span>üîó Unlink YouTube Channel</span>
                    }
                </button>
                @if (!string.IsNullOrEmpty(unlinkError))
                {
                    <div class="alert alert-error" style="margin-top: 10px;">@unlinkError</div>
                }
                @if (!string.IsNullOrEmpty(unlinkSuccess))
                {
                    <div class="alert alert-success" style="margin-top: 10px;">@unlinkSuccess</div>
                }
            }
            else
            {
                <p><strong>YouTube:</strong> Not linked</p>
            }
        </div>
    }
    <button @onclick="() => showProfileModal = false">Close</button>
</Modal>

<!-- Link YouTube Modal -->
<Modal @bind-IsOpen="showLinkYouTubeModal">
    <h3>üì∫ Link YouTube Channel</h3>
    <p>Choose how you want to link your YouTube channel:</p>
    
    @if (!youtubeLinkMethodSelected)
    {
        <div style="display: flex; flex-direction: column; gap: 10px;">
            @if (allowViewerOAuth)
            {
                <button @onclick="() => SelectLinkMethod(true)" style="padding: 15px;">
                    <strong>üîê Google Sign-In</strong><br/>
                    <small style="color: var(--text-dim);">Instant linking via OAuth (requires setup)</small>
                </button>
            }
            <button @onclick="() => SelectLinkMethod(false)" style="padding: 15px;">
                <strong>üé´ Verification Code</strong><br/>
                <small style="color: var(--text-dim);">Generate a code to send in chat</small>
            </button>
            <button @onclick="CloseLinkYouTubeModal" style="background: var(--bg-light); color: var(--text);">Cancel</button>
        </div>
    }
    else if (useOAuthMethod)
    {
        @if (isOAuthConfigured)
        {
            <div id="google-signin-container" style="padding: 20px 0;">
                <div id="g_id_onload"
                     data-client_id="@googleClientId"
                     data-context="use"
                     data-ux_mode="popup"
                     data-callback="handleGoogleCallback"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin" 
                     data-type="standard"
                     data-size="large"
                     data-theme="outline"
                     data-text="signin_with"
                     data-shape="rectangular"
                     data-logo_alignment="left">
                </div>
                <div style="margin-top: 10px; padding: 10px; background: var(--bg-light); border-radius: 4px; font-size: 12px;">
                    <strong>Debug Info:</strong><br/>
                    Client ID: @googleClientId<br/>
                    <em>If the Google button doesn't appear above, try refreshing the page or check browser console for errors.</em>
                </div>
            </div>
            <p style="margin-top: 15px; color: var(--text-dim); font-size: 14px;">
                Click the "Sign in with Google" button above to link your YouTube channel.
            </p>
            @if (!string.IsNullOrEmpty(oauthError))
            {
                <div class="alert alert-error" style="margin-top: 10px;">@oauthError</div>
            }
            @if (!string.IsNullOrEmpty(oauthSuccess))
            {
                <div class="alert alert-success" style="margin-top: 10px;">@oauthSuccess</div>
            }
        }
        else
        {
            <div class="alert alert-warning">
                <p><strong>YouTube OAuth Not Configured</strong></p>
                <p>To use Google Sign-In for YouTube linking, you need to:</p>
                <ol style="text-align: left; margin: 10px 0;">
                    <li>Go to the <a href="/setup" target="_blank">Setup page</a></li>
                    <li>Configure YouTube OAuth credentials (Client ID and Client Secret)</li>
                    <li>Return here to link your channel</li>
                </ol>
            </div>
        }
        <button @onclick="ResetLinkMethod" style="background: var(--bg-light); color: var(--text); margin-top: 10px;">Back</button>
    }
    else
    {
        @if (string.IsNullOrEmpty(youtubeLinkCode))
        {
            <p>Generate a code to send in your YouTube chat or Super Chat:</p>
            <button @onclick="GenerateYouTubeLinkCode">Generate Link Code</button>
            @if (!string.IsNullOrEmpty(linkError))
            {
                <div class="alert alert-error" style="margin-top: 10px;">@linkError</div>
            }
        }
        else if (linkSuccessful)
        {
            <div class="alert alert-success">
                <p style="font-size: 18px; margin: 10px 0;">‚úì YouTube channel successfully linked!</p>
                <p>Your channel is now connected to your account.</p>
            </div>
            <button @onclick="CloseLinkYouTubeModal" style="margin-top: 10px;">Close</button>
        }
        else
        {
            <div class="alert alert-success">
                <p><strong>Your Link Code:</strong></p>
                <p style="font-size: 24px; font-weight: bold; letter-spacing: 4px; margin: 10px 0;">@youtubeLinkCode</p>
                <p>Send this code in the YouTube chat or as a Super Chat message to link your channel.</p>
                <p style="color: var(--text-dim); font-size: 12px;">This code expires in 30 minutes.</p>
                <p style="color: var(--warning); font-size: 12px; margin-top: 10px;">
                    ‚è±Ô∏è <strong>Note:</strong> It may take up to 30 seconds for the system to detect your message and link your account. Please be patient!
                </p>
            </div>
            <button @onclick="ResetLinkMethod" style="background: var(--bg-light); color: var(--text); margin-top: 10px;">Back</button>
        }
    }
</Modal>

@code {
    [Parameter]
    public Account? CurrentAccount { get; set; }

    [Parameter]
    public EventCallback OnAccountChanged { get; set; }

    private bool showLoginModal = false;
    private bool showProfileModal = false;
    private bool showLinkYouTubeModal = false;
    private string loginUsername = "";
    private string loginPassword = "";
    private string loginError = "";
    private string linkError = "";
    private string oauthError = "";
    private string oauthSuccess = "";
    private bool unlinkingYouTube = false;
    private string unlinkError = "";
    private string unlinkSuccess = "";

    private bool youtubeLinkMethodSelected = false;
    private bool useOAuthMethod = false;
    private string? youtubeLinkCode = null;
    private bool linkSuccessful = false;
    private bool isOAuthConfigured = false;
    private bool allowViewerOAuth = true;
    private string? googleClientId = null;
    private DotNetObjectReference<AccountBar>? objRef;

    protected override void OnInitialized()
    {
        // Create the DotNetObjectReference during initialization
        objRef = DotNetObjectReference.Create(this);
        
        // Subscribe to account linking events
        AccountService.OnChannelLinked += HandleChannelLinked;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && objRef != null)
        {
            // Register this component instance with JavaScript
            await JS.InvokeVoidAsync("setAccountBarReference", objRef);
        }
    }

    private async Task OpenLinkYouTubeModal()
    {
        showLinkYouTubeModal = true;
        await Task.CompletedTask;
    }

    private void CloseLinkYouTubeModal()
    {
        showLinkYouTubeModal = false;
        ResetLinkMethod();
    }
    
    private void HandleChannelLinked(string channelId, string username)
    {
        // Only show success if this is the current user's account
        if (CurrentAccount != null && CurrentAccount.Username == username)
        {
            InvokeAsync(() =>
            {
                linkSuccessful = true;
                StateHasChanged();
            });
        }
    }

    private async Task SelectLinkMethod(bool useOAuth)
    {
        youtubeLinkMethodSelected = true;
        useOAuthMethod = useOAuth;
        oauthError = "";
        oauthSuccess = "";
        linkError = "";

        if (useOAuth)
        {
            // Check if OAuth is configured
            var settings = SettingsService.Settings;
            isOAuthConfigured = !string.IsNullOrEmpty(settings.YouTube.ClientId);
            allowViewerOAuth = settings.YouTube.AllowViewerOAuth;
            googleClientId = settings.YouTube.ClientId;

            if (isOAuthConfigured)
            {
                // Re-register the component reference in case it was lost
                if (objRef != null)
                {
                    await JS.InvokeVoidAsync("setAccountBarReference", objRef);
                }
                
                // Force re-render to show Google Sign-In button
                StateHasChanged();
                
                // Give Google Sign-In library time to initialize the button
                await Task.Delay(100);
                
                // Try to manually initialize Google Sign-In
                try
                {
                    await JS.InvokeVoidAsync("eval", $@"
                        setTimeout(function() {{
                            if (typeof google !== 'undefined' && google.accounts && google.accounts.id) {{
                                console.log('Initializing Google Sign-In with client ID: {googleClientId}');
                                google.accounts.id.initialize({{
                                    client_id: '{googleClientId}',
                                    callback: handleGoogleCallback
                                }});
                                google.accounts.id.renderButton(
                                    document.querySelector('.g_id_signin'),
                                    {{ 
                                        theme: 'outline', 
                                        size: 'large',
                                        text: 'signin_with'
                                    }}
                                );
                                console.log('Google Sign-In button rendered');
                            }} else {{
                                console.error('Google Sign-In library not loaded yet');
                            }}
                        }}, 500);
                    ");
                }
                catch (Exception ex)
                {
                    oauthError = $"Failed to initialize Google Sign-In: {ex.Message}";
                    StateHasChanged();
                }
            }
        }
    }

    private void ResetLinkMethod()
    {
        youtubeLinkMethodSelected = false;
        useOAuthMethod = false;
        youtubeLinkCode = null;
        linkSuccessful = false;
        isOAuthConfigured = false;
        oauthError = "";
        oauthSuccess = "";
        linkError = "";
    }

    [JSInvokable]
    public async Task HandleGoogleSignInCallback(string credential)
    {
        try
        {
            oauthError = "";
            oauthSuccess = "";

            if (CurrentAccount == null)
            {
                oauthError = "You must be logged in to link a YouTube channel";
                StateHasChanged();
                return;
            }

            // Call the account service to link the YouTube channel
            var success = AccountService.LinkYouTubeChannelViaGoogle(CurrentAccount.Id, credential, googleClientId);

            if (success)
            {
                oauthSuccess = "‚úì YouTube channel linked successfully!";
                
                // Refresh account data
                await OnAccountChanged.InvokeAsync();
                
                // Close modal after a short delay
                await Task.Delay(2000);
                CloseLinkYouTubeModal();
            }
            else
            {
                oauthError = "Failed to link YouTube channel. It may already be linked to another account.";
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            oauthError = $"Error: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private async Task UnlinkYouTube()
    {
        try
        {
            unlinkingYouTube = true;
            unlinkError = "";
            unlinkSuccess = "";
            StateHasChanged();
            
            if (CurrentAccount == null)
            {
                unlinkError = "Not logged in";
                unlinkingYouTube = false;
                StateHasChanged();
                return;
            }
            
            // Call AccountService directly (server-side Blazor)
            var success = AccountService.UnlinkYouTubeChannel(CurrentAccount.Id);
            
            if (success)
            {
                unlinkSuccess = "‚úì YouTube channel unlinked successfully! You can now link a different channel.";
                
                // Refresh account data
                await OnAccountChanged.InvokeAsync();
                
                // Close modal after a short delay
                await Task.Delay(2000);
                showProfileModal = false;
                unlinkSuccess = "";
            }
            else
            {
                unlinkError = "Failed to unlink YouTube channel";
            }
            
            unlinkingYouTube = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            unlinkError = $"Error: {ex.Message}";
            unlinkingYouTube = false;
            StateHasChanged();
        }
    }

    private async Task Login()
    {
        try
        {
            loginError = "";
            var (success, error, account, sessionToken) = AccountService.Login(loginUsername, loginPassword);
            if (success && account != null && sessionToken != null)
            {
                // Store only the secure session token, not credentials
                await JS.InvokeVoidAsync("localStorage.setItem", "sessionToken", sessionToken);
                showLoginModal = false;
                loginUsername = "";
                loginPassword = "";
                await OnAccountChanged.InvokeAsync();
            }
            else
            {
                loginError = error ?? "Invalid username or password";
            }
        }
        catch (Exception ex)
        {
            loginError = $"Login failed: {ex.Message}";
        }
    }

    private async Task Register()
    {
        try
        {
            loginError = "";
            var (success, error, account) = AccountService.CreateAccount(loginUsername, loginPassword);
            if (success && account != null)
            {
                // Login after registration
                var (loginSuccess, _, loginAccount, sessionToken) = AccountService.Login(loginUsername, loginPassword);
                if (loginSuccess && loginAccount != null && sessionToken != null)
                {
                    // Store only the secure session token, not credentials
                    await JS.InvokeVoidAsync("localStorage.setItem", "sessionToken", sessionToken);
                    showLoginModal = false;
                    loginUsername = "";
                    loginPassword = "";
                    await OnAccountChanged.InvokeAsync();
                }
                else
                {
                    loginError = "Account created but login failed. Please login manually.";
                }
            }
            else
            {
                loginError = error ?? "Registration failed";
            }
        }
        catch (Exception ex)
        {
            loginError = $"Registration failed: {ex.Message}";
        }
    }

    private async Task HandleLogout()
    {
        // Get current session token before clearing
        var sessionToken = await JS.InvokeAsync<string>("localStorage.getItem", "sessionToken");
        
        // Remove from localStorage
        await JS.InvokeVoidAsync("localStorage.removeItem", "sessionToken");
        
        // Invalidate session on server
        if (!string.IsNullOrEmpty(sessionToken))
        {
            AccountService.Logout(sessionToken);
        }
        
        await OnAccountChanged.InvokeAsync();
    }

    private async Task LoginButtonClicked()
    {
        showLoginModal = true;
        await Task.CompletedTask;
    }

    private async Task GenerateYouTubeLinkCode()
    {
        try
        {
            linkError = "";
            if (CurrentAccount != null)
            {
                youtubeLinkCode = AccountService.GenerateYouTubeLinkCode(CurrentAccount.Id);
            }
        }
        catch (Exception ex)
        {
            linkError = $"Failed to generate code: {ex.Message}";
        }
        await Task.CompletedTask;
    }

    public void Dispose()
    {
        AccountService.OnChannelLinked -= HandleChannelLinked;
        objRef?.Dispose();
    }
}
