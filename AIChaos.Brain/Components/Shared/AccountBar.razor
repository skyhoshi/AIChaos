@inject AccountService AccountService
@inject IJSRuntime JS

@if (CurrentAccount == null)
{
    <button @onclick="() => showLoginModal = true" style="padding: 8px 16px;">üîì Login / Register</button>
}
else
{
    <div class="user-profile">
        @if (!string.IsNullOrEmpty(CurrentAccount.PictureUrl))
        {
            <img src="@CurrentAccount.PictureUrl" alt="" style="width: 28px; height: 28px; border-radius: 50%;">
        }
        <span @onclick="() => showProfileModal = true" style="cursor: pointer;" title="View profile">@CurrentAccount.DisplayName</span>
        <span class="credits-display">$ <span>@CurrentAccount.CreditBalance.ToString("F2")</span></span>
        @if (!string.IsNullOrEmpty(CurrentAccount.LinkedYouTubeChannelId))
        {
            <span style="color: var(--success); font-size: 12px;">‚úì YouTube Linked</span>
        }
        else
        {
            <button @onclick="() => showLinkYouTubeModal = true" title="Link YouTube Channel"
                    style="background: none; border: none; color: var(--warning); cursor: pointer; font-size: 12px;">üì∫ Link YouTube</button>
        }
        <button @onclick="HandleLogout"
                style="background: none; border: none; color: var(--text-dim); cursor: pointer;">(Logout)</button>
    </div>
}

<!-- Login/Register Modal -->
<Modal @bind-IsOpen="showLoginModal">
    <h3>üîê Account Access</h3>
    <div class="form-group">
        <label>Username</label>
        <input type="text" @bind="loginUsername" placeholder="Enter username">
    </div>
    <div class="form-group">
        <label>Password</label>
        <input type="password" @bind="loginPassword" placeholder="Enter password">
    </div>
    @if (!string.IsNullOrEmpty(loginError))
    {
        <div class="alert alert-error">@loginError</div>
    }
    <div style="display: flex; gap: 10px;">
        <button @onclick="Login">Login</button>
        <button @onclick="Register">Register</button>
        <button @onclick="() => showLoginModal = false" style="background: var(--bg-light); color: var(--text);">Cancel</button>
    </div>
</Modal>

<!-- Profile Modal -->
<Modal @bind-IsOpen="showProfileModal">
    <h3>üë§ Your Profile</h3>
    @if (CurrentAccount != null)
    {
        <div style="margin: 15px 0;">
            <p><strong>Username:</strong> @CurrentAccount.Username</p>
            <p><strong>Display Name:</strong> @CurrentAccount.DisplayName</p>
            <p><strong>Role:</strong> @CurrentAccount.Role</p>
            <p><strong>Credits:</strong> $@CurrentAccount.CreditBalance.ToString("F2")</p>
            @if (!string.IsNullOrEmpty(CurrentAccount.LinkedYouTubeChannelId))
            {
                <p><strong>YouTube:</strong> ‚úì Linked (@CurrentAccount.LinkedYouTubeChannelId)</p>
            }
            else
            {
                <p><strong>YouTube:</strong> Not linked</p>
            }
        </div>
    }
    <button @onclick="() => showProfileModal = false">Close</button>
</Modal>

<!-- Link YouTube Modal -->
<Modal @bind-IsOpen="showLinkYouTubeModal">
    <h3>üì∫ Link YouTube Channel</h3>
    <p>Choose how you want to link your YouTube channel:</p>
    
    @if (!youtubeLinkMethodSelected)
    {
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button @onclick="() => SelectLinkMethod(true)" style="padding: 15px;">
                <strong>üîê Google Sign-In</strong><br/>
                <small style="color: var(--text-dim);">Instant linking via OAuth (requires setup)</small>
            </button>
            <button @onclick="() => SelectLinkMethod(false)" style="padding: 15px;">
                <strong>üé´ Verification Code</strong><br/>
                <small style="color: var(--text-dim);">Generate a code to send in chat</small>
            </button>
            <button @onclick="() => showLinkYouTubeModal = false" style="background: var(--bg-light); color: var(--text);">Cancel</button>
        </div>
    }
    else if (useOAuthMethod)
    {
        @if (!string.IsNullOrEmpty(youtubeOAuthUrl))
        {
            <p>‚úÖ Click the button below to link via Google:</p>
            <button @onclick="OpenYouTubeOAuth">
                Open Google Sign-In
            </button>
        }
        else
        {
            <div class="alert alert-warning">
                YouTube OAuth is not configured. Please set up OAuth credentials in the Setup page first.
            </div>
        }
        <button @onclick="ResetLinkMethod" style="background: var(--bg-light); color: var(--text); margin-top: 10px;">Back</button>
    }
    else
    {
        @if (string.IsNullOrEmpty(youtubeLinkCode))
        {
            <p>Generate a code to send in your YouTube chat or Super Chat:</p>
            <button @onclick="GenerateYouTubeLinkCode">Generate Link Code</button>
        }
        else
        {
            <div class="alert alert-success">
                <p><strong>Your Link Code:</strong></p>
                <p style="font-size: 24px; font-weight: bold; letter-spacing: 4px; margin: 10px 0;">@youtubeLinkCode</p>
                <p>Send this code in the YouTube chat or as a Super Chat message to link your channel.</p>
                <p style="color: var(--text-dim); font-size: 12px;">This code expires in 30 minutes.</p>
            </div>
        }
        <button @onclick="ResetLinkMethod" style="background: var(--bg-light); color: var(--text); margin-top: 10px;">Back</button>
    }
</Modal>

@code {
    [Parameter]
    public Account? CurrentAccount { get; set; }
    
    [Parameter]
    public EventCallback OnAccountChanged { get; set; }

    private bool showLoginModal = false;
    private bool showProfileModal = false;
    private bool showLinkYouTubeModal = false;
    private string loginUsername = "";
    private string loginPassword = "";
    private string loginError = "";
    
    private bool youtubeLinkMethodSelected = false;
    private bool useOAuthMethod = false;
    private string? youtubeLinkCode = null;
    private string? youtubeOAuthUrl = null;

    private void SelectLinkMethod(bool useOAuth)
    {
        youtubeLinkMethodSelected = true;
        useOAuthMethod = useOAuth;
        
        if (useOAuth)
        {
            // Check if OAuth is configured
            // This would need to call a settings endpoint
            youtubeOAuthUrl = null; // Set if configured
        }
    }

    private void ResetLinkMethod()
    {
        youtubeLinkMethodSelected = false;
        useOAuthMethod = false;
        youtubeLinkCode = null;
    }

    private async Task Login()
    {
        try
        {
            loginError = "";
            var (success, error, account, sessionToken) = AccountService.Login(loginUsername, loginPassword);
            if (success && account != null)
            {
                await JS.InvokeVoidAsync("localStorage.setItem", "accountSession", System.Text.Json.JsonSerializer.Serialize(new { username = account.Username, password = loginPassword }));
                showLoginModal = false;
                loginUsername = "";
                loginPassword = "";
                await OnAccountChanged.InvokeAsync();
            }
            else
            {
                loginError = error ?? "Invalid username or password";
            }
        }
        catch (Exception ex)
        {
            loginError = $"Login failed: {ex.Message}";
        }
    }

    private async Task Register()
    {
        try
        {
            loginError = "";
            var (success, error, account) = AccountService.CreateAccount(loginUsername, loginPassword);
            if (success && account != null)
            {
                // Login after registration
                var (loginSuccess, loginError, loginAccount, sessionToken) = AccountService.Login(loginUsername, loginPassword);
                if (loginSuccess && loginAccount != null)
                {
                    await JS.InvokeVoidAsync("localStorage.setItem", "accountSession", System.Text.Json.JsonSerializer.Serialize(new { username = loginAccount.Username, password = loginPassword }));
                    showLoginModal = false;
                    loginUsername = "";
                    loginPassword = "";
                    await OnAccountChanged.InvokeAsync();
                }
                else
                {
                    loginError = "Account created but login failed. Please login manually.";
                }
            }
            else
            {
                loginError = error ?? "Registration failed";
            }
        }
        catch (Exception ex)
        {
            loginError = $"Registration failed: {ex.Message}";
        }
    }

    private async Task HandleLogout()
    {
        await JS.InvokeVoidAsync("localStorage.removeItem", "accountSession");
        await OnAccountChanged.InvokeAsync();
    }

    private async Task GenerateYouTubeLinkCode()
    {
        try
        {
            if (CurrentAccount != null)
            {
                youtubeLinkCode = AccountService.GenerateYouTubeLinkCode(CurrentAccount.Id);
            }
        }
        catch (Exception ex)
        {
            loginError = $"Failed to generate code: {ex.Message}";
        }
    }

    private async Task OpenYouTubeOAuth()
    {
        if (!string.IsNullOrEmpty(youtubeOAuthUrl))
        {
            await JS.InvokeVoidAsync("open", youtubeOAuthUrl, "_blank");
        }
    }
}
